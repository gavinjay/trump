<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trump (Court Piece)</title>
    <!-- We'll use the 'Inter' font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- PeerJS for multiplayer -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --table-green: #0a6c3a;
            --table-green-dark: #074f2a;
            --card-bg: #ffffff;
            --card-border: #999;
            --text-light: #f0f0f0;
            --text-dark: #1a1a1a;
            --suit-red: #d90000;
            --suit-black: #1a1a1a;
            --highlight-player: #ffeb3b;
            --highlight-card: #00bfff;
            --team-red: #ff5c5c; /* NEW */
            --team-blue: #5c8cff; /* NEW */
        }

        /* Basic Setup */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #333;
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 100vh;
            max-height: 700px;
            background-color: var(--table-green);
            border: 10px solid var(--table-green-dark);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Status Bar */
        #status-bar {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--table-green-dark);
            border-bottom: 2px solid rgba(0, 0, 0, 0.3);
            font-size: 1rem;
            font-weight: 600;
            gap: 20px;
        }

        /* Score Bar */
        #score-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 20px;
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 2px solid var(--table-green-dark);
            font-size: 0.9rem;
        }

        #score-display {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            font-size: 0.9rem;
            line-height: 1.3;
        }

        #score-display #hand-score {
            font-weight: 400;
            font-style: italic;
            color: #ccc;
        }

        /* NEW: Team color text */
        .team-red-text {
            color: var(--team-red);
            font-weight: 700;
        }
        .team-blue-text {
            color: var(--team-blue);
            font-weight: 700;
        }

        #trump-display {
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
            justify-self: center;
        }

        #status-message {
            text-align: right;
            font-style: italic;
            min-height: 1.2em;
            flex: 1;
        }

        #status-icons-left {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-self: start;
        }

        #status-icons {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-self: end;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        #share-btn {
            font-size: 1.8rem;
            font-weight: 400;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        /* Game Table Layout */
        #game-table {
            position: relative;
            flex-grow: 1;
            width: 100%;
        }

        /* Player Positions */
        .player-area {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            min-width: 120px;
            box-sizing: border-box;
        }

        .player-area.active-player {
            box-shadow: 0 0 20px 5px var(--highlight-player);
            transform: scale(1.05);
            z-index: 10;
        }

        .player-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-info {
            font-size: 0.8rem;
            color: #ccc;
        }

        #player-south-area {
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
        }

        #player-north-area {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        #player-west-area {
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
        }

        #player-east-area {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
        }

        /* Card Styling */
        .card, .card-back {
            width: 60px;
            height: 90px;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            color: var(--text-dark);
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
            box-sizing: border-box;
            user-select: none;
            transition: all 0.3s ease;
        }

        .card-back {
            background-color: #55a;
            background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.1) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
        }

        .card-rank {
            line-height: 1;
        }
        .card-suit {
            font-size: 1.5rem;
            line-height: 1;
            align-self: center;
        }
        .card-rank-bottom {
            transform: rotate(180deg);
        }

        .card.suit-S, .card.suit-C { color: var(--suit-black); }
        .card.suit-H, .card.suit-D { color: var(--suit-red); }

        /* AI Player Hands */
        .ai-hand {
            display: flex;
            position: relative;
            margin-top: 5px;
            height: 90px;
        }
        .ai-hand .card-back {
            position: absolute;
        }
        #player-north-area .ai-hand .card-back {
            left: calc(var(--i) * 15px);
        }
        #player-west-area .ai-hand, #player-east-area .ai-hand {
            width: 60px;
        }
        #player-west-area .ai-hand .card-back,
        #player-east-area .ai-hand .card-back {
            top: calc(var(--i) * 10px);
        }

        /* Player's (South's) Hand */
        #player-hand-south {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            width: 100%;
            height: 100px; /* Card height + hover room */
            z-index: 100;
        }

        #player-hand-south .card {
            position: absolute;
            cursor: pointer;
            transition: all 0.2s ease-out;
            bottom: 0;
            /* FIX: Explicitly center the cards so fanning works from the middle */
            left: 50%;
            margin-left: -30px; /* Half of card width (60px) */
        }

        #player-hand-south .card:hover {
            transform: translateY(-20px) scale(1.05);
            z-index: 150;
        }

        #player-hand-south .card.playable {
            box-shadow: 0 0 15px 3px var(--highlight-card);
            border: 2px solid var(--highlight-card);
        }

        #player-hand-south .card.playable:hover {
            transform: translateY(-20px) scale(1.1);
        }

        #player-hand-south .card.disabled {
            filter: grayscale(80%) brightness(0.8);
            cursor: not-allowed;
        }

        #player-hand-south .card.disabled:hover {
            transform: none;
        }

        /* Trick Area (Center Table) */
        #trick-area {
            position: absolute;
            top: 50%;
            left: 50%;
            /* REMOVED width/height */
            transform: translate(-50%, -50%);
            /* REMOVED grid properties */
        }

        #trick-area .card {
            position: relative;
            animation: play-card-anim 0.3s ease-out;
        }

        @keyframes play-card-anim {
            from { opacity: 0; transform: scale(0.5) rotate(90deg); }
            to { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        /* NEW: Position all card slots absolutely */
        #trick-card-south, #trick-card-north, #trick-card-west, #trick-card-east {
            position: absolute;
            transform: translate(-50%, -50%); /* Center the slot itself */
        }

        /* NEW: Tweak positions to be less centered */
        #trick-card-south { top: 50px; } /* Was grid-area: south */
        #trick-card-north { top: -50px; } /* Was grid-area: north */
        #trick-card-west { left: -60px; } /* Was grid-area: west */
        #trick-card-east { left: 60px; } /* Was grid-area: east */

        /* Won Trick Stacks -- REMOVED */
        /* .won-tricks-stack { ... } */
        /* .won-tricks-stack .card-back { ... } */
        /* .won-tricks-stack .card-back:nth-child(even) { ... } */


        /* Modal Overlays */
        #modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        #modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #f4f4f4;
            color: var(--text-dark);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            text-align: center;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        #modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        /* NEW: Special style for trump select modal to keep hand visible */
        #modal-overlay.trump-select {
            background-color: rgba(0, 0, 0, 0.4); /* Lighter dim */
            align-items: flex-start;
        }

        #modal-overlay.trump-select .modal-content {
            margin-top: 15vh; /* Push down from top, leaving room for hand */
        }

        .modal-content h2 {
            margin-top: 0;
            font-size: 1.8rem;
        }

        .modal-content p {
            font-size: 1.1rem;
            margin-bottom: 25px;
        }

        #trump-selection-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .trump-btn {
            font-family: 'Inter', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            width: 80px;
            height: 80px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .trump-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .trump-btn.suit-S, .trump-btn.suit-C { color: var(--suit-black); background-color: #eee; }
        .trump-btn.suit-H, .trump-btn.suit-D { color: var(--suit-red); background-color: #fff0f0; }

        #play-again-btn {
            font-family: 'Inter', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: var(--table-green-dark);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #play-again-btn:hover {
            background-color: #0b8046;
            transform: scale(1.05);
        }

        #play-again-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #666;
        }

        #play-again-btn:disabled:hover {
            background-color: #666;
            transform: none;
        }

        /* Main Menu Styles */
        #main-menu-modal {
            max-width: 400px;
            width: 90%;
        }

        .menu-btn {
            font-family: 'Inter', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .menu-btn:hover {
            transform: scale(1.02);
        }

        .menu-btn-primary {
            background-color: var(--table-green-dark);
            color: var(--text-light);
        }

        .menu-btn-primary:hover {
            background-color: #0b8046;
        }

        .menu-btn-secondary {
            background-color: #5c8cff;
            color: white;
        }

        .menu-btn-secondary:hover {
            background-color: #4a7ae8;
        }

        .menu-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #999;
        }

        .menu-btn:disabled:hover {
            background-color: #999;
            transform: none;
        }

        #join-input {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            text-align: center;
            text-transform: uppercase;
        }

        #join-input:focus {
            outline: none;
            border-color: var(--table-green);
        }

        #host-info {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #host-info p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        #game-code {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--table-green-dark);
            letter-spacing: 3px;
        }

        #share-link {
            font-size: 0.75rem;
            word-break: break-all;
            color: #666;
        }

        .copy-btn {
            font-size: 0.8rem;
            padding: 5px 10px;
            margin-left: 5px;
            background: var(--table-green-dark);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #waiting-message {
            font-style: italic;
            color: #666;
        }

        #connection-status {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .status-connected {
            background-color: #c8e6c9;
            color: #2e7d32;
        }

        .status-waiting {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .status-error {
            background-color: #ffcdd2;
            color: #c62828;
        }

        .back-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .back-btn:hover {
            color: #333;
        }

        #kick-player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .kick-player-item {
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kick-player-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .kick-btn {
            padding: 6px 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .kick-btn:hover {
            background: #b71c1c;
        }

        /* Name Input */
        #name-input {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
            text-align: center;
        }

        #name-input:focus {
            outline: none;
            border-color: var(--table-green);
        }

        /* Lobby Styles */
        .lobby-container {
            text-align: left;
        }

        .lobby-teams {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .lobby-team {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            min-height: 120px;
        }

        .lobby-team-red {
            background-color: rgba(255, 92, 92, 0.15);
            border: 2px solid var(--team-red);
        }

        .lobby-team-blue {
            background-color: rgba(92, 140, 255, 0.15);
            border: 2px solid var(--team-blue);
        }

        .lobby-team h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
        }

        .lobby-player {
            padding: 5px 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lobby-player-filled {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .lobby-player-empty {
            background-color: rgba(0, 0, 0, 0.1);
            color: #999;
            font-style: italic;
        }

        .lobby-player-you {
            font-weight: 700;
        }

        .team-select-btn {
            font-size: 0.7rem;
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background: var(--table-green-dark);
            color: white;
        }

        .team-select-btn:hover {
            background: #0b8046;
        }

        #start-game-btn {
            margin-top: 10px;
        }

        #start-game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive Design */
        @media (max-width: 700px) {
            #game-container {
                max-height: none;
                height: 100vh;
                border-radius: 0;
                border: none;
            }

            .card, .card-back {
                width: 50px;
                height: 75px;
                font-size: 1rem;
            }
            .card-suit { font-size: 1.2rem; }

            #player-hand-south { /* <-- FIX: Was #player-hand */
                height: 85px; /* Card height + hover room */
            }

            .player-area {
                padding: 5px;
                min-width: 90px;
            }
            .player-name { font-size: 0.9rem; }
            .player-info { font-size: 0.7rem; }

            #player-west-area .ai-hand, #player-east-area .ai-hand {
                width: 50px;
            }
            .ai-hand { height: 75px; }

            #trick-area {
                /* REMOVED width/height */
            }

            /* Won Stacks Responsive -- REMOVED */
            /* .won-tricks-stack { ... } */
            /* .won-tricks-stack .card-back { ... } */
            /* #won-tricks-north { ... } */
            /* #won-tricks-south { ... } */
            /* #won-tricks-west { ... } */
            /* #won-tricks-east { ... } */

            /* NEW: Adjust trick positions for smaller screen */
            #trick-card-south { top: 45px; }
            #trick-card-north { top: -45px; }
            #trick-card-west { left: -45px; }
            #trick-card-east { left: 45px; }

            #status-bar {
                padding: 8px 10px;
            }

            #score-bar {
                font-size: 0.8rem;
                padding: 6px 10px;
            }

            #trump-display {
                font-size: 1rem;
            }

            .modal-content {
                padding: 20px;
                width: 85%;
            }
            .modal-content h2 { font-size: 1.5rem; }
            .modal-content p { font-size: 1rem; }
            .trump-btn {
                font-size: 2rem;
                width: 60px;
                height: 60px;
            }
        }

        @media (max-height: 500px) {
             #player-hand-south {
                bottom: 5px;
                height: 80px;
            }
            #player-hand-south .card:hover {
                transform: translateY(-10px) scale(1.05);
            }
            #player-hand-south .card.playable:hover {
                transform: translateY(-10px) scale(1.1);
            }
            #player-south-area {
                bottom: 90px;
                font-size: 0.8rem;
            }
        }

        /* Mobile-specific styles */
        @media (max-width: 480px) {
            html, body {
                height: 100%;
                height: -webkit-fill-available;
                overflow: hidden;
                position: fixed;
                width: 100%;
            }

            #game-container {
                max-height: none;
                height: 100%;
                height: -webkit-fill-available;
                border-radius: 0;
                border-width: 0;
            }

            .card, .card-back {
                width: 45px;
                height: 68px;
                font-size: 0.7rem;
                border-radius: 4px;
            }

            .card .rank-suit {
                font-size: 0.9rem;
            }

            #player-hand-south {
                bottom: 10px;
                height: 75px;
            }

            #player-hand-south .card {
                margin-left: -22px;
            }

            #player-south-area {
                bottom: 95px;
                padding: 5px 8px;
                min-width: 80px;
            }

            .player-area {
                padding: 5px 8px;
                min-width: 70px;
            }

            .player-name {
                font-size: 0.75rem;
            }

            .player-info {
                font-size: 0.65rem;
            }

            #status-bar {
                padding: 8px 10px;
            }

            #score-bar {
                padding: 6px 10px;
                font-size: 0.7rem;
            }

            #trump-display {
                font-size: 1rem;
            }

            .icon-btn {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }

            #status-icons {
                gap: 5px;
            }

            #status-icons-left {
                left: 10px;
            }

            .modal-content {
                width: 90%;
                max-height: 85vh;
                overflow-y: auto;
                padding: 15px;
            }

            .menu-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .trump-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            #trick-card-south, #trick-card-north,
            #trick-card-east, #trick-card-west {
                position: absolute;
            }

            #trick-card-south { top: 35px; }
            #trick-card-north { top: -35px; }
            #trick-card-west { left: -35px; }
            #trick-card-east { left: 35px; }

            /* Lobby styles for mobile */
            .lobby-teams {
                flex-direction: column;
                gap: 10px;
            }

            .lobby-player {
                padding: 8px;
                font-size: 0.8rem;
            }

            #name-input {
                font-size: 0.9rem;
                padding: 10px;
            }

            /* Reaction picker for mobile */
            #reaction-picker {
                padding: 20px;
                gap: 15px;
                max-width: 95vw;
            }

            .reaction-option {
                font-size: 2.5rem;
                padding: 15px 20px;
                min-width: 60px;
                min-height: 60px;
            }

            /* Safe area for iPhone notch */
            #status-bar {
                padding-top: max(6px, env(safe-area-inset-top));
            }

            #player-hand-south {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* NEW: Special Event Overlay (Ace Catch King) */
        #special-event-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 500; /* Above everything but modal */
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            pointer-events: none;
        }

        #special-event-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #special-event-message {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--highlight-player);
            text-align: center;
            text-shadow: 0 0 20px #000;
            transform: scale(0.7);
            transition: all 0.5s ease;
            white-space: pre-wrap; /* To allow line breaks */
        }

        #special-event-overlay.visible #special-event-message {
            transform: scale(1);
        }

        @media (max-width: 700px) {
            #special-event-message {
                font-size: 2.5rem;
            }
        }

        /* Reaction System */
        .reaction-btn {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 4px 8px;
            margin-left: 10px;
            transition: all 0.2s ease;
            display: inline-block;
            line-height: 1;
        }

        .reaction-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            border-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.2);
        }

        .reaction-btn:active {
            transform: scale(0.95);
        }

        #reaction-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 4px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            max-width: 90vw;
            justify-content: center;
        }

        .reaction-option {
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            font-size: 3.5rem;
            cursor: pointer;
            padding: 20px 25px;
            transition: all 0.2s ease;
            line-height: 1;
            min-width: 80px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reaction-option:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.2);
        }

        .reaction-option:active {
            transform: scale(0.95);
        }

        .player-reaction {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 2rem;
            animation: reaction-pop 0.5s ease-out;
            pointer-events: none;
        }

        @keyframes reaction-pop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); opacity: 1; }
        }

    </style>
</head>
<body>

    <div id="game-container">
        <!-- Top Status Bar -->
        <div id="status-bar">
            <div id="status-icons-left">
                <button id="menu-btn" class="icon-btn" title="Menu" style="display: none;">‚ò∞</button>
            </div>
            <div id="trump-display"></div>
            <div id="status-icons">
                <button id="help-btn" class="icon-btn" title="Game Rules">?</button>
                <button id="share-btn" class="icon-btn" title="Invite Players" style="display: none;">+</button>
            </div>
        </div>

        <!-- Score Bar -->
        <div id="score-bar">
            <div id="score-display">
                <span id="game-score">Games: <span id="game-score-red" class="team-red-text">0</span> - <span id="game-score-blue" class="team-blue-text">0</span></span>
                <span id="hand-score">Hands: <span id="hand-score-red" class="team-red-text">0</span> - <span id="hand-score-blue" class="team-blue-text">0</span></span>
            </div>
            <div id="status-message">Starting new game...</div>
        </div>

        <!-- Main Game Table -->
        <div id="game-table">
            <!-- AI Player North -->
            <div class="player-area" id="player-north-area">
                <div class="player-name">
                    North (AI)
                    <button class="reaction-btn" id="reaction-btn-north" title="Send Reaction" style="display: none;">ÔøΩ</buutton>
                </div>
                <!-- UPDATED: Team Red -->
                <div class="player-info"><span class="team-red-text">Team Red</span> | <span id="card-count-north">0</span> cards</div>
                <div class="ai-hand" id="ai-hand-north"></div>
                <div class="player-reaction" id="reaction-north"></div>
            </div>

            <!-- AI Player West -->
            <div class="player-area" id="player-west-area">
                <div class="player-name">
                    West (AI)
                    <button class="reaction-btn" id="reaction-btn-west" title="Send Reaction" style="display: none;">ÔøΩ<//button>
                </div>
                <!-- UPDATED: Team Blue -->
                <div class="player-info"><span class="team-blue-text">Team Blue</span> | <span id="card-count-west">0</span> cards</div>
                <div class="ai-hand" id="ai-hand-west"></div>
                <div class="player-reaction" id="reaction-west"></div>
            </div>

            <!-- AI Player East -->
            <div class="player-area" id="player-east-area">
                <div class="player-name">
                    East (AI)
                    <button class="reaction-btn" id="reaction-btn-east" title="Send Reaction" style="display: none;">ÔøΩ<</button>
                </div>
                <!-- UPDATED: Team Blue -->
                <div class="player-info"><span class="team-blue-text">Team Blue</span> | <span id="card-count-east">0</span> cards</div>
                <div class="ai-hand" id="ai-hand-east"></div>
                <div class="player-reaction" id="reaction-east"></div>
            </div>

            <!-- Human Player South Area (Name/Info) -->
            <div class="player-area" id="player-south-area">
                <div class="player-name">
                    South (You)
                    <button class="reaction-btn" id="reaction-btn-south" title="Send Reaction">ÔøΩ</button>
                </div>
                <!-- UPDATED: Team Red -->
                <div class="player-info"><span class="team-red-text">Team Red</span> | <span id="card-count-south">0</span> cards</div>
                <div class="player-reaction" id="reaction-south"></div>
            </div>

            <!-- Won trick stacks -- REMOVED -->
            <!-- <div class="won-tricks-stack" id="won-tricks-north"></div> ... -->

            <!-- Center Trick Area -->
            <div id="trick-area">
                <div id="trick-card-north"></div>
                <div id="trick-card-west"></div>
                <div id="trick-card-east"></div>
                <div id="trick-card-south"></div>
            </div>

        </div>

        <!-- Human Player's Hand (Cards) -->
        <div id="player-hand-south">
            <!-- Player's cards will be dynamically inserted here -->
        </div>

        <!-- Modal Overlays -->
        <div id="modal-overlay">
            <!-- Main Menu Modal -->
            <div id="main-menu-modal" class="modal-content" style="display: none;">
                <h2>New Game</h2>

                <!-- Initial Menu -->
                <div id="menu-main">
                    <input type="text" id="name-input" placeholder="Enter your name" maxlength="20">
                    <button class="menu-btn menu-btn-primary" id="play-ai-btn">Play vs AI</button>
                    <button class="menu-btn menu-btn-secondary" id="host-game-btn">Host Game</button>
                    <button class="menu-btn menu-btn-secondary" id="join-game-btn">Join Game</button>
                </div>

                <!-- Host/Join Lobby View -->
                <div id="menu-lobby" style="display: none;">
                    <div id="host-info">
                        <p>Game Code: <span id="game-code">------</span>
                            <button class="copy-btn" id="copy-code-btn">Copy</button>
                        </p>
                        <p id="share-link-container" style="font-size: 0.75rem; color: #666;">
                            <span id="share-link"></span>
                            <button class="copy-btn" id="copy-link-btn">Copy Link</button>
                        </p>
                    </div>

                    <div class="lobby-container">
                        <div class="lobby-teams">
                            <div class="lobby-team lobby-team-red">
                                <h4 class="team-red-text">Team Red</h4>
                                <div id="lobby-red-slot1" class="lobby-player lobby-player-empty">
                                    <span>Empty</span>
                                </div>
                                <div id="lobby-red-slot2" class="lobby-player lobby-player-empty">
                                    <span>Empty</span>
                                </div>
                            </div>
                            <div class="lobby-team lobby-team-blue">
                                <h4 class="team-blue-text">Team Blue</h4>
                                <div id="lobby-blue-slot1" class="lobby-player lobby-player-empty">
                                    <span>Empty</span>
                                </div>
                                <div id="lobby-blue-slot2" class="lobby-player lobby-player-empty">
                                    <span>Empty</span>
                                </div>
                            </div>
                        </div>

                        <div id="lobby-status" class="status-waiting">Waiting for players...</div>
                        <button class="menu-btn menu-btn-primary" id="start-game-btn">Start Game</button>
                    </div>
                    <button class="back-btn" id="lobby-back-btn">‚Üê Back to Menu</button>
                </div>

                <!-- Join Game View -->
                <div id="menu-join" style="display: none;">
                    <input type="text" id="join-name-input" placeholder="Enter your name" maxlength="20">
                    <p style="margin-top: 10px;">Enter Game Code:</p>
                    <input type="text" id="join-input" placeholder="XXXXXX" maxlength="6">
                    <button class="menu-btn menu-btn-secondary" id="join-connect-btn">Connect</button>
                    <div id="join-status"></div>
                    <button class="back-btn" id="join-back-btn">‚Üê Back to Menu</button>
                </div>
            </div>

            <!-- Trump Selection Modal -->
            <div id="trump-selection-modal" class="modal-content" style="display: none;">
                <h2 id="trump-modal-title">Select Trump Suit</h2>
                <p id="trump-modal-text">Select the trump suit for this hand.</p>
                <div id="trump-selection-buttons">
                    <button class="trump-btn suit-S" data-suit="S">‚ô†</button>
                    <button class="trump-btn suit-H" data-suit="H">‚ô•</button>
                    <button class="trump-btn suit-D" data-suit="D">‚ô¶</button>
                    <button class="trump-btn suit-C" data-suit="C">‚ô£</button>
                </div>
            </div>

            <!-- Game Over Modal -->
            <div id="game-over-modal" class="modal-content" style="display: none;">
                <button id="play-again-btn">Play Again</button>
            </div>

            <!-- Help Modal -->
            <div id="help-modal" class="modal-content" style="display: none; max-width: 500px; max-height: 80vh; overflow-y: scroll; text-align: left; padding: 15px; font-size: 0.85rem;">
                <h2 style="margin: 0 0 10px 0; font-size: 1.3rem;">How to Play Trump</h2>
                
                <h3 style="font-size: 1rem; margin: 12px 0 6px 0;">Overview</h3>
                <p style="margin: 5px 0; font-size: 0.85rem;">4-player team game. Team Red (South & North) vs Team Blue (East & West). First to 7 games wins!</p>
                
                <h3 style="font-size: 1rem; margin: 12px 0 6px 0;">Setup</h3>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li style="margin: 3px 0; font-size: 0.85rem;">Each player gets 13 cards</li>
                    <li style="margin: 3px 0; font-size: 0.85rem;">5 cards dealt first for trump selection</li>
                    <li style="margin: 3px 0; font-size: 0.85rem;">Remaining 8 cards dealt after trump chosen</li>
                </ul>
                
                <h3 style="font-size: 1rem; margin: 12px 0 6px 0;">Trump Selection</h3>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li style="margin: 3px 0; font-size: 0.85rem;">Winning team picks trump</li>
                    <li style="margin: 3px 0; font-size: 0.85rem;">Trump beats all other suits</li>
                </ul>
                
                <h3 style="font-size: 1rem; margin: 12px 0 6px 0;">Playing</h3>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li style="margin: 3px 0; font-size: 0.85rem;">Must follow suit if possible</li>
                    <li style="margin: 3px 0; font-size: 0.85rem;">Highest card of led suit wins (unless trump played)</li>
                    <li style="margin: 3px 0; font-size: 0.85rem;">Winner leads next hand</li>
                </ul>
                
                <h3 style="font-size: 1rem; margin: 12px 0 6px 0;">Scoring</h3>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li style="margin: 3px 0; font-size: 0.85rem;">First to 7 hands wins the game</li>
                    <li style="margin: 3px 0; font-size: 0.85rem;">First to 7 games wins the match</li>
                    <li style="margin: 3px 0; font-size: 0.85rem;"><strong>COAT:</strong> 7-0 victory</li>
                </ul>
                
                <h3 style="font-size: 1rem; margin: 12px 0 6px 0;">Special Rules</h3>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li style="margin: 3px 0; font-size: 0.85rem;"><strong>Ace Catch King:</strong> If King & Ace of trump played by opposing teams, Ace team wins match instantly!</li>
                    <li style="margin: 3px 0; font-size: 0.85rem;"><strong>No Trumps:</strong> If any player has no trump cards, redeal</li>
                </ul>
                
                <p style="margin: 10px 0 5px 0; font-size: 0.8rem;"><strong>Card Ranks:</strong> A, K, Q, J, 10, 9, 8, 7, 6, 5, 4, 3, 2</p>
                
                <button class="menu-btn menu-btn-primary" id="close-help-btn" style="width: 100%; margin-top: 15px; padding: 10px; cursor: pointer;">Got it!</button>
            </div>

            <!-- Share Modal -->
            <div id="share-modal" class="modal-content" style="display: none; max-width: 400px;">
                <h2>Share Game</h2>
                <p>Share this code or link with friends to join your game:</p>
                <div id="share-code-display" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p style="margin: 5px 0; font-size: 0.9rem;">Game Code:</p>
                    <p id="share-code-text" style="font-size: 1.8rem; font-weight: 700; color: var(--table-green-dark); letter-spacing: 3px; margin: 5px 0;">------</p>
                    <button class="copy-btn" id="copy-code-btn">Copy Code</button>
                </div>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin: 15px 0;">
                    <p style="margin: 5px 0; font-size: 0.75rem; color: #666;">Share Link:</p>
                    <p id="share-url-text" style="font-size: 0.75rem; word-break: break-all; color: #666; margin: 5px 0;"></p>
                    <button class="copy-btn" id="copy-url-btn">Copy Link</button>
                </div>
                <button class="menu-btn menu-btn-primary" id="close-share-btn">Close</button>
            </div>

            <!-- Game Menu Modal -->
            <div id="game-menu-modal" class="modal-content" style="display: none; max-width: 400px;">
                <h2>Game Menu</h2>
                <button class="menu-btn menu-btn-primary" id="new-game-btn">New Game</button>
                <button class="menu-btn menu-btn-secondary" id="kick-player-btn" style="display: none;">Kick Player</button>
                <button class="menu-btn menu-btn-secondary" id="host-link-btn" style="display: none;">Host Link</button>
                <button class="menu-btn menu-btn-secondary" id="about-btn">About</button>
                <button class="back-btn" id="close-game-menu-btn">‚Üê Back to Game</button>
            </div>

            <!-- Kick Player Modal -->
            <div id="kick-player-modal" class="modal-content" style="display: none; max-width: 400px;">
                <h2>Kick Player</h2>
                <p>Select a player to remove from the game:</p>
                <div id="kick-player-list"></div>
                <button class="back-btn" id="back-to-game-menu-btn">‚Üê Back</button>
            </div>

            <!-- About Modal -->
            <div id="about-modal" class="modal-content" style="display: none; max-width: 500px; text-align: center;">
                <h2>About Trump</h2>
                <p style="font-size: 1rem; margin: 20px 0;">Made by <strong>gavinjay</strong><br><a href="https://g9it.com" target="_blank" style="color: var(--table-green-dark); text-decoration: none;">g9it.com</a></p>
                <p style="font-size: 0.95rem; line-height: 1.6; text-align: left; margin: 20px 0;">I created this game to celebrate a childhood classic: Trump (In no relation to donnie), A Guyanese classic!!</p>
                <p style="font-size: 0.95rem; line-height: 1.6; text-align: left; margin: 20px 0;">Turns out... is very specific to Guyana and similar rules don't exist elsewhere! (probably based on an incorrect understanding of the original rules of some other game)</p>
                <p style="font-size: 0.95rem; line-height: 1.6; text-align: left; margin: 20px 0; font-style: italic;">Don't forget to grab a rum and coke and a cuttaz!!</p>
                <button class="menu-btn menu-btn-primary" id="close-about-btn">Close</button>
            </div>

            <!-- Team Selection Modal (for guests joining) -->
            <div id="team-selection-modal" class="modal-content" style="display: none; max-width: 450px;">
                <h2>Choose Your Team</h2>
                <p>Select which team you'd like to join:</p>
                <div class="lobby-teams" style="margin: 20px 0;">
                    <div class="lobby-team lobby-team-red">
                        <h4 class="team-red-text">Team Red</h4>
                        <div id="team-select-red-slots"></div>
                        <button class="menu-btn menu-btn-primary" id="join-team-red-btn" style="margin-top: 10px;">Join Team Red</button>
                    </div>
                    <div class="lobby-team lobby-team-blue">
                        <h4 class="team-blue-text">Team Blue</h4>
                        <div id="team-select-blue-slots"></div>
                        <button class="menu-btn menu-btn-primary" id="join-team-blue-btn" style="margin-top: 10px;">Join Team Blue</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW Special Event Overlay -->
        <div id="special-event-overlay">
            <div id="special-event-message"></div>
        </div>

        <!-- Reaction Picker -->
        <div id="reaction-picker" style="display: none;">
            <button class="reaction-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
            <button class="reaction-option" data-emoji="üëç">üëç</button>
            <button class="reaction-option" data-emoji="üëé">üëé</button>
            <button class="reaction-option" data-emoji="ÔøΩ">ÔøΩ</butttton>
            <button class="reaction-option" data-emoji="ÔøΩ">>ÔøΩ</butto>n>
            <button class="reaction-option" data-emoji="üñï">üñï</button>
            <button class="reaction-option" data-emoji="üò†">üò†</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONSTANTS ---
            const SUITS = ['S', 'H', 'D', 'C'];
            const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const POSITIONS = ['south', 'east', 'north', 'west']; // Counter-clockwise
            const RANK_VALUES = {
                '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
                'J': 11, 'Q': 12, 'K': 13, 'A': 14
            };
            const AI_THINK_TIME = 1000; // ms

            // Position rotation mappings - maps logical position to visual position based on viewer
            // Visual positions: south=bottom, west=left, north=top, east=right
            const ROTATION_MAP = {
                south: { south: 'south', west: 'west', north: 'north', east: 'east' },
                north: { north: 'south', east: 'west', south: 'north', west: 'east' },
                east: { east: 'south', south: 'west', west: 'north', north: 'east' },
                west: { west: 'south', north: 'west', east: 'north', south: 'east' }
            };

            // Get visual position for a logical position (based on myPosition)
            function getVisualPosition(logicalPos) {
                return ROTATION_MAP[myPosition][logicalPos];
            }

            // Get logical position from visual position (inverse mapping)
            function getLogicalPosition(visualPos) {
                const map = ROTATION_MAP[myPosition];
                for (const [logical, visual] of Object.entries(map)) {
                    if (visual === visualPos) return logical;
                }
                return visualPos;
            }

            // --- DOM ELEMENTS ---
            const gameContainer = document.getElementById('game-container');
            const statusBar = {
                score: document.getElementById('score-display'),
                gameScore: document.getElementById('game-score'), // Original text span
                handScore: document.getElementById('hand-score'), // Original text span
                gameScoreRed: document.getElementById('game-score-red'), // NEW
                gameScoreBlue: document.getElementById('game-score-blue'), // NEW
                handScoreRed: document.getElementById('hand-score-red'), // NEW
                handScoreBlue: document.getElementById('hand-score-blue'), // NEW
                message: document.getElementById('status-message'),
            };
            const playerAreas = {
                south: document.getElementById('player-south-area'),
                north: document.getElementById('player-north-area'),
                west: document.getElementById('player-west-area'),
                east: document.getElementById('player-east-area'),
            };
            const playerHands = {
                south: document.getElementById('player-hand-south'),
                north: document.getElementById('ai-hand-north'),
                west: document.getElementById('ai-hand-west'),
                east: document.getElementById('ai-hand-east'),
            };
            const cardCounts = {
                south: document.getElementById('card-count-south'),
                north: document.getElementById('card-count-north'),
                west: document.getElementById('card-count-west'),
                east: document.getElementById('card-count-east'),
            };
            const trickArea = document.getElementById('trick-area');
            const trickCards = {
                south: document.getElementById('trick-card-south'),
                north: document.getElementById('trick-card-north'),
                west: document.getElementById('trick-card-west'),
                east: document.getElementById('trick-card-east'),
            };
            // REMOVED wonTricksStacks
            const modalOverlay = document.getElementById('modal-overlay');
            const trumpModal = document.getElementById('trump-selection-modal');
            const trumpButtons = document.getElementById('trump-selection-buttons');
            const gameOverModal = document.getElementById('game-over-modal');
            const playAgainBtn = document.getElementById('play-again-btn');
            const specialEventOverlay = document.getElementById('special-event-overlay'); // NEW
            const specialEventMessage = document.getElementById('special-event-message'); // NEW

            // Menu elements
            const mainMenuModal = document.getElementById('main-menu-modal');
            const menuMain = document.getElementById('menu-main');
            const menuLobby = document.getElementById('menu-lobby');
            const menuJoin = document.getElementById('menu-join');
            const nameInput = document.getElementById('name-input');
            const joinNameInput = document.getElementById('join-name-input');
            const gameCodeDisplay = document.getElementById('game-code');
            const shareLinkDisplay = document.getElementById('share-link');
            const lobbyStatus = document.getElementById('lobby-status');
            const joinInput = document.getElementById('join-input');
            const joinStatus = document.getElementById('join-status');
            const startGameBtn = document.getElementById('start-game-btn');

            // --- GAME STATE ---
            let deck = [];
            let players = {};
            let matchScores = { teamRed: 0, teamBlue: 0 }; // Tracks games won (first to 7 games wins match)
            let currentHand = []; // { player, card } objects - the 4 cards currently being played
            let trumpSuit = null;
            let trumpCaller = 'south';
            let handLeader = 'south'; // Who leads the current hand
            let currentPlayer = 'south';
            let gameHandCounts = { teamRed: 0, teamBlue: 0 }; // Tracks hands won in current game (first to 7 hands wins game)
            let gameState = 'INIT'; // INIT, DEALING, TRUMP_SELECTION, PLAYING, HAND_OVER, GAME_OVER, MATCH_OVER

            // --- MULTIPLAYER STATE ---
            let peer = null;
            let connections = [];
            let isHost = false;
            let isMultiplayer = false;
            let myPosition = 'south'; // The human player's position
            let gameCode = '';
            let myName = '';

            // Lobby state - tracks all players in lobby
            // positions: south, north, east, west
            // Each slot: { name: string, oderId: string, team: 'teamRed'|'teamBlue', position: string }
            let lobbyPlayers = {
                south: null,  // Team Red
                north: null,  // Team Red
                east: null,   // Team Blue
                west: null    // Team Blue
            };

            // Player names for display during game
            let playerNames = {
                south: 'South',
                north: 'North',
                east: 'East',
                west: 'West'
            };

            // --- CORE GAME LOGIC ---

            /**
             * Initializes a new match from scratch. Resets match scores.
             */
            function initMatch() {
                console.log("Initializing new match...");
                matchScores = { teamRed: 0, teamBlue: 0 }; // Reset match scores
                trumpCaller = 'south'; // South calls trump first
                gameState = 'TRUMP_SELECTION'; // Start with trump selection
                currentPlayer = trumpCaller; // The caller is the current player
                trumpSuit = null; // Reset trump for the new game
                handLeader = null; // Will be set by setTrump
                
                // Hide all modals explicitly
                hideModal();
                mainMenuModal.style.display = 'none';
                document.getElementById('team-selection-modal').style.display = 'none';

                // --- Deal 5 cards for trump selection ---
                deck = createDeck();
                shuffleDeck(deck);

                // Determine which positions are human based on lobby
                let isNorthAI = true, isEastAI = true, isWestAI = true;
                if (isMultiplayer && isHost) {
                    isNorthAI = !lobbyPlayers.north;
                    isEastAI = !lobbyPlayers.east;
                    isWestAI = !lobbyPlayers.west;
                }

                players = {
                    south: { hand: [], isAI: false, team: 'teamRed' },
                    east: { hand: [], isAI: isEastAI, team: 'teamBlue' },
                    north: { hand: [], isAI: isNorthAI, team: 'teamRed' },
                    west: { hand: [], isAI: isWestAI, team: 'teamBlue' },
                };
                currentHand = [];
                handTrickCounts = { teamRed: 0, teamBlue: 0 };

                updateStatusMessage('Dealing initial cards...');
                updateScoreDisplay();
                updateHandScoreDisplay();
                updateTrumpDisplay();
                clearTrickArea();

                // 1. Deal 5 cards to each player
                for (let i = 0; i < 5; i++) {
                    for (const pos of POSITIONS) {
                        players[pos].hand.push(deck.pop());
                    }
                }

                // Sort hands for all human players
                sortHand(players.south.hand);
                if (isMultiplayer && isHost) {
                    for (const pos of ['north', 'east', 'west']) {
                        if (lobbyPlayers[pos]) {
                            sortHand(players[pos].hand);
                        }
                    }
                }
                renderAllHands();

                // Send state to guest in multiplayer
                if (isMultiplayer && isHost) {
                    sendGameState();
                }

                // 2. Go to trump selection
                setTimeout(() => {
                    promptForTrump();
                }, 500);
            }

            /**
             * Starts a new hand (one round of 13 tricks).
             * @param {string} winningTeam - The team that won the previous hand and gets to pick trump
             */
            function startNewHand(winningTeam) {
                console.log(`--- Starting New Hand ---`);
                gameState = 'TRUMP_SELECTION';

                // Hide all modals (in case any are open)
                hideModal();
                mainMenuModal.style.display = 'none';
                document.getElementById('team-selection-modal').style.display = 'none';

                // Set trump caller from the winning team
                if (winningTeam === 'teamRed') {
                    // Alternate between south and north for Team Red
                    trumpCaller = (trumpCaller === 'south') ? 'north' : 'south';
                } else {
                    // Alternate between east and west for Team Blue
                    trumpCaller = (trumpCaller === 'east' || trumpCaller === 'south' || trumpCaller === 'north') ? 'east' : 'west';
                    if (trumpCaller !== 'east' && trumpCaller !== 'west') {
                        trumpCaller = 'east';
                    }
                }
                currentPlayer = trumpCaller;
                trumpSuit = null; // Reset trump for new hand

                // Reset hands and deck
                deck = createDeck();
                shuffleDeck(deck);

                // Determine which positions are human based on lobby
                let isNorthAI = true, isEastAI = true, isWestAI = true;
                if (isMultiplayer && isHost) {
                    isNorthAI = !lobbyPlayers.north;
                    isEastAI = !lobbyPlayers.east;
                    isWestAI = !lobbyPlayers.west;
                }

                players = {
                    south: { hand: [], isAI: false, team: 'teamRed' },
                    east: { hand: [], isAI: isEastAI, team: 'teamBlue' },
                    north: { hand: [], isAI: isNorthAI, team: 'teamRed' },
                    west: { hand: [], isAI: isWestAI, team: 'teamBlue' },
                };

                // Reset trick data
                currentHand = [];
                handTrickCounts = { teamRed: 0, teamBlue: 0 };

                updateStatusMessage('Dealing initial cards...');
                updateScoreDisplay();
                updateHandScoreDisplay();
                updateTrumpDisplay();
                clearTrickArea();

                // 1. Deal 5 cards to each player for trump selection
                for (let i = 0; i < 5; i++) {
                    for (const pos of POSITIONS) {
                        players[pos].hand.push(deck.pop());
                    }
                }

                // Sort hands for all human players
                sortHand(players.south.hand);
                if (isMultiplayer && isHost) {
                    for (const pos of ['north', 'east', 'west']) {
                        if (lobbyPlayers[pos]) {
                            sortHand(players[pos].hand);
                        }
                    }
                }
                renderAllHands();

                // Send state to guests
                if (isMultiplayer && isHost) {
                    sendGameState();
                }

                // 2. Go to trump selection
                setTimeout(() => {
                    promptForTrump();
                }, 500);
            }

            /**
             * Creates a standard 52-card deck.
             */
            function createDeck() {
                const newDeck = [];
                SUITS.forEach(suit => {
                    RANKS.forEach(rank => {
                        newDeck.push({
                            suit: suit,
                            rank: rank,
                            value: RANK_VALUES[rank],
                            id: `${rank}-${suit}` // Unique ID for DOM
                        });
                    });
                });
                return newDeck;
            }

            /**
             * Shuffles a deck array in place (Fisher-Yates).
             */
            function shuffleDeck(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            /**
             * Sorts a player's hand by suit, then rank.
             * NEW: Sorts trump suit to the far right.
             */
             function sortHand(hand) {
                const suitOrder = { 'S': 1, 'H': 2, 'D': 3, 'C': 4 };

                hand.sort((a, b) => {
                    // Check if trumpSuit is set
                    if (trumpSuit) {
                        const aIsTrump = a.suit === trumpSuit;
                        const bIsTrump = b.suit === trumpSuit;

                        if (aIsTrump && !bIsTrump) {
                            return 1; // a is trump, b is not -> a comes after b
                        }
                        if (!aIsTrump && bIsTrump) {
                            return -1; // b is trump, a is not -> a comes before b
                        }
                    }

                    // If both are trump or both are not (or trump isn't set), sort normally
                    if (a.suit !== b.suit) {
                        return suitOrder[a.suit] - suitOrder[b.suit];
                    }
                    return a.value - b.value;
                });
            }

            /**
             * Asks the current trump caller to select trump.
             */
            function promptForTrump() {
                console.log(`Prompting ${currentPlayer} for trump.`);
                updateStatusMessage(`${capitalize(currentPlayer)} is selecting trump...`);
                highlightActivePlayer(currentPlayer);

                // Check if the current player is the local human
                const isLocalHuman = (currentPlayer === myPosition);

                if (isLocalHuman) {
                    // Show modal for human player
                    document.getElementById('trump-modal-title').textContent = "Select Trump Suit";
                    document.getElementById('trump-modal-text').textContent = "Select the trump suit for this round.";
                    
                    // Hide all other modals explicitly
                    mainMenuModal.style.display = 'none';
                    gameOverModal.style.display = 'none';
                    document.getElementById('help-modal').style.display = 'none';
                    document.getElementById('share-modal').style.display = 'none';
                    document.getElementById('game-menu-modal').style.display = 'none';
                    document.getElementById('team-selection-modal').style.display = 'none';
                    document.getElementById('kick-player-modal').style.display = 'none';
                    document.getElementById('about-modal').style.display = 'none';
                    
                    trumpModal.style.display = 'block';
                    showModal();
                    modalOverlay.classList.add('trump-select'); // NEW: Special class
                } else if (players[currentPlayer].isAI) {
                    // AI selects trump
                    setTimeout(() => {
                        const aiHand = players[currentPlayer].hand;
                        const chosenSuit = aiSelectTrump(aiHand);
                        setTrump(chosenSuit);
                    }, AI_THINK_TIME * 1.5);
                } else {
                    // It's another human player's turn (multiplayer guest)
                    if (isHost) {
                        sendGameState(); // Let guest know it's their turn to select trump
                    }
                }
            }

            /**
             * AI logic for selecting a trump suit from 5 cards.
             */
            function aiSelectTrump(hand) {
                const suitCounts = { S: 0, H: 0, D: 0, C: 0 };
                let bestSuit = SUITS[Math.floor(Math.random() * 4)]; // Default random
                let maxCount = 0;

                hand.forEach(card => {
                    suitCounts[card.suit]++;
                });

                for (const suit in suitCounts) {
                    if (suitCounts[suit] > maxCount) {
                        maxCount = suitCounts[suit];
                        bestSuit = suit;
                    }
                }
                console.log(`AI (${currentPlayer}) chose trump: ${bestSuit} (had ${maxCount})`);
                return bestSuit;
            }

            /**
             * Sets the trump suit, deals remaining cards, and starts play.
             */
            function setTrump(suit) {
                console.log(`Trump set to: ${suit}`);
                trumpSuit = suit; // This is now set for the whole game
                handLeader = trumpCaller; // The caller leads the first hand
                currentPlayer = trumpCaller;

                hideModal();
                modalOverlay.classList.remove('trump-select'); // NEW: Clean up
                updateTrumpDisplay();
                updateStatusMessage(`Trump is ${getSuitSymbol(trumpSuit)}. Dealing remaining cards...`);

                // 3. Deal remaining 8 cards (to add to the 5)
                for (let i = 0; i < 8; i++) {
                    for (const pos of POSITIONS) {
                        if (deck.length > 0) { // Safety check
                            players[pos].hand.push(deck.pop());
                        }
                    }
                }

                // Re-sort human hands with all 13 cards
                sortHand(players.south.hand);
                if (isMultiplayer && isHost) {
                    for (const pos of ['north', 'east', 'west']) {
                        if (lobbyPlayers[pos]) {
                            sortHand(players[pos].hand);
                        }
                    }
                }
                renderAllHands();

                // Check if any player has NO trump cards
                let playerWithNoTrumps = null;
                for (const pos of POSITIONS) {
                    const hasTrump = players[pos].hand.some(card => card.suit === trumpSuit);
                    if (!hasTrump) {
                        playerWithNoTrumps = pos;
                        break;
                    }
                }

                if (playerWithNoTrumps) {
                    // Someone has no trumps - redeal
                    const playerTeam = players[playerWithNoTrumps].team;
                    const teamName = playerTeam === 'teamRed' ? 'RED' : 'BLUE';
                    const teamColor = playerTeam === 'teamRed' ? 'var(--team-red)' : 'var(--team-blue)';
                    
                    console.log(`${playerWithNoTrumps} has no trumps! Redealing...`);
                    specialEventMessage.style.color = teamColor;
                    showSpecialEventMessage(`${teamName}\nNO TRUMPS\nRE-DEAL!`, 2000);
                    
                    setTimeout(() => {
                        specialEventMessage.style.color = 'var(--highlight-player)';
                        // Restart the hand with same trump caller
                        if (isMultiplayer && isHost) {
                            broadcast({ type: 'redeal' });
                        }
                        startNewHand(playerTeam); // Same team picks trump again
                    }, 2200);
                    return; // Don't start the game
                }

                // 4. Start first trick
                gameState = 'PLAYING';

                // Broadcast trump selection and game state in multiplayer
                if (isMultiplayer && isHost) {
                    broadcast({ type: 'trumpSelected', suit: suit });
                    sendGameState();
                }

                setTimeout(() => {
                    updateStatusMessage(`Trump is ${getSuitSymbol(trumpSuit)}. ${capitalize(handLeader)} starts.`);
                    nextTurn();
                }, 1000);
            }

            /**
             * Manages the flow of the game, passing control to the next player.
             */
            function nextTurn() {
                if (gameState !== 'PLAYING') return;

                console.log(`Turn: ${currentPlayer}`);
                highlightActivePlayer(currentPlayer);

                // Check if current player is human
                const isHumanTurn = !players[currentPlayer].isAI;

                if (isHumanTurn) {
                    // Human player's turn
                    if (currentPlayer === myPosition) {
                        updateStatusMessage("Your turn. Select a card to play.");
                        highlightPlayableCards();
                    } else {
                        // It's the other human's turn (in multiplayer)
                        updateStatusMessage(`Waiting for ${capitalize(currentPlayer)}...`);
                        if (isHost) {
                            sendGameState(); // Let guest know it's their turn
                        }
                    }
                } else {
                    // AI player's turn
                    updateStatusMessage(`${capitalize(currentPlayer)}'s turn...`);
                    setTimeout(aiPlayCard, AI_THINK_TIME);
                }
            }

            /**
             * AI logic for playing a card.
             */
            function aiPlayCard() {
                if (gameState !== 'PLAYING' || players[currentPlayer].isAI === false) return;

                const player = currentPlayer;
                const hand = players[player].hand;
                const ledSuit = currentHand.length > 0 ? currentHand[0].card.suit : null;
                const playableCards = getPlayableCards(hand, ledSuit);

                // --- Simple AI Strategy ---
                let cardToPlay = null;

                // Get info about the trick
                const winningEntry = currentHand.length > 0 ? findWinningTrickEntry(currentHand, trumpSuit) : null;
                const isPartnerWinning = winningEntry && players[winningEntry.player].team === players[player].team;

                if (ledSuit) {
                    // --- Following suit ---
                    if (playableCards[0].suit === ledSuit) {
                        // Must follow suit.
                        if (isPartnerWinning) {
                             // Partner is winning, play lowest card.
                            cardToPlay = playableCards[0]; // Already sorted low to high
                        } else {
                            // Partner not winning (or we are leading). Try to win.
                            const winningValue = winningEntry ? winningEntry.card.value : 0;
                            // Find smallest card that can win
                            let bestCard = playableCards.find(c => c.value > winningValue);
                            if (bestCard) {
                                cardToPlay = bestCard;
                            } else {
                                // Can't win, play lowest card.
                                cardToPlay = playableCards[0];
                            }
                        }
                    } else {
                        // --- Can't follow suit ---
                        const trumpCards = playableCards.filter(c => c.suit === trumpSuit);
                        const nonTrumpCards = playableCards.filter(c => c.suit !== trumpSuit);

                        if (isPartnerWinning) {
                            // "Walk aside". Play lowest non-trump card if possible.
                            if (nonTrumpCards.length > 0) {
                                cardToPlay = nonTrumpCards[0];
                            } else {
                                // Forced to play trump, play lowest.
                                cardToPlay = trumpCards[0];
                            }
                        } else {
                            // Try to "cut" (trump). Play lowest trump if possible.
                            if (trumpCards.length > 0) {
                                cardToPlay = trumpCards[0];
                            } else {
                                // No trump, just "walk aside". Play lowest card.
                                cardToPlay = nonTrumpCards[0];
                            }
                        }
                    }
                } else {
                    // --- Leading the trick ---
                    // Simple: lead a random high non-trump card if possible.
                    const nonTrumps = hand.filter(c => c.suit !== trumpSuit);
                    if (nonTrumps.length > 0) {
                        // Sort high to low
                        nonTrumps.sort((a, b) => b.value - a.value);
                        cardToPlay = nonTrumps[0]; // Play highest non-trump
                    } else {
                        // Only have trump, play lowest.
                        hand.sort((a, b) => a.value - b.value);
                        cardToPlay = hand[0];
                    }
                }

                // Fallback: just play a random playable card
                if (!cardToPlay) {
                    cardToPlay = playableCards[Math.floor(Math.random() * playableCards.length)];
                }

                // --- End AI Strategy ---

                // Find the card in the actual hand to remove it
                const cardIndex = hand.findIndex(c => c.id === cardToPlay.id);
                const card = hand.splice(cardIndex, 1)[0];

                playCard(player, card);
            }

            /**
             * Processes a card being played by any player.
             */
            function playCard(player, card) {
                console.log(`${player} plays: ${card.id}`);
                gameState = 'CARD_PLAYED'; // Temp state to prevent clicks

                // Add to trick
                currentHand.push({ player, card });

                // Update UI
                renderPlayedCard(player, card);
                renderAllHands();

                // Broadcast in multiplayer
                if (isMultiplayer && isHost) {
                    broadcast({ type: 'cardPlayed', player: player, card: card });
                    sendGameState();
                }

                // --- Check for "Ace Catch King" ---
                const kingOfTrump = currentHand.find(c => c.card.suit === trumpSuit && c.card.rank === 'K');
                const aceOfTrump = currentHand.find(c => c.card.suit === trumpSuit && c.card.rank === 'A');

                if (kingOfTrump && aceOfTrump) {
                    const kingTeam = players[kingOfTrump.player].team;
                    const aceTeam = players[aceOfTrump.player].team;

                    // Trigger if both ace and king of trump are in same trick AND on different teams
                    // Ace always catches king regardless of play order
                    if (kingTeam !== aceTeam) {
                        const winner = aceOfTrump.player;
                        const winnerTeam = aceTeam;
                        console.log(`!!! ACE CATCH KING by ${winner} !!!`);

                        // --- NEW ---
                        const winnerName = (winnerTeam === 'teamRed') ? "Team Red" : "Team Blue";
                        showSpecialEventMessage(`ACE CATCH KING!\n${winnerName} wins!`);

                        // Delay the game-over modal to let the message be seen
                        setTimeout(() => {
                            showGameOver(winnerTeam, "Ace Catch King!");
                        }, 2800);
                        // --- END NEW ---

                        return; // Stop the game
                    }
                }
                // --- End Ace/King Check ---

                // Check if trick is over
                if (currentHand.length === 4) {
                    gameState = 'TRICK_OVER';
                    highlightActivePlayer(null);
                    setTimeout(endTrick, AI_THINK_TIME * 1.5); // Pause to see cards
                } else {
                    gameState = 'PLAYING';
                    currentPlayer = getNextPlayer(player);
                    nextTurn();
                }
            }

            /**
             * Called when all 4 cards are in the trick.
             */
            function endTrick() {
                if (gameState !== 'TRICK_OVER') return;

                const winningEntry = findWinningTrickEntry(currentHand, trumpSuit);
                const winner = winningEntry.player;
                const winnerTeam = players[winner].team;

                handTrickCounts[winnerTeam]++;
                // REMOVED playerTrickCounts[winner]++;
                handLeader = winner; // Winner leads next hand
                currentPlayer = winner;

                console.log(`Trick over. Winner: ${winner} (${winnerTeam}).`);
                updateStatusMessage(`${capitalize(winner)} wins the hand!`); // UPDATED: trick -> hand
                updateHandScoreDisplay(); // NEW

                // Show "TAKES THE HAND!" animation for each trick won
                const winnerName = winnerTeam === 'teamRed' ? 'RED' : 'BLUE';
                const winnerColor = winnerTeam === 'teamRed' ? 'var(--team-red)' : 'var(--team-blue)';
                specialEventMessage.style.color = winnerColor;
                console.log(`Showing TAKES THE HAND animation for ${winnerName}`);
                showSpecialEventMessage(`${winnerName}\nTAKES THE HAND!`, 600); // Fast animation (doubled speed)
                
                setTimeout(() => {
                    specialEventMessage.style.color = 'var(--highlight-player)';
                }, 600);

                // REMOVED addCardToWonStack(winner);

                // --- NEW: Check for hand-ending trick ---
                if (handTrickCounts[winnerTeam] === 7) {
                    gameState = 'HAND_OVER';
                    console.log(`Hand over. ${winnerTeam} won 7 tricks.`);
                    updateStatusMessage(`${capitalize(winnerTeam)} wins the round!`); // UPDATED: hand -> round

                    // Call endHand, but force the winner
                    setTimeout(() => endHand(winnerTeam), AI_THINK_TIME * 2); // Pass winner
                    return; // Don't continue to clear trick or start next turn
                }
                // --- End new check ---

                // Clear trick area after a delay
                setTimeout(() => {
                    currentHand = [];
                    clearTrickArea();

                    // Check if hand is over (no cards left)
                    if (players.south.hand.length === 0) {
                        gameState = 'HAND_OVER';
                        endHand(); // No parameter, will tally score
                    } else {
                        gameState = 'PLAYING';
                        updateStatusMessage(`${capitalize(currentPlayer)} leads next hand.`); // UPDATED: trick -> hand
                        nextTurn();
                    }
                }, AI_THINK_TIME);
            }

            /**
             * Called when all 13 tricks are played OR one team wins 7 tricks.
             * @param {string} [forcedWinnerTeam] - If provided, this team wins the hand.
                 */
            function endHand(forcedWinnerTeam) {
                console.log("Hand over.");

                let handWinner = forcedWinnerTeam;
                let message = '';

                if (!handWinner) {
                    // Hand played all 13 tricks, determine winner
                    const teamRed = handTrickCounts.teamRed; // UPDATED
                    const teamBlue = handTrickCounts.teamBlue; // UPDATED
                    message = `Round over! Hands: Team Red (${teamRed}) - Team Blue (${teamBlue}). `; // UPDATED

                    if (teamRed > teamBlue) { // UPDATED
                        handWinner = 'teamRed'; // UPDATED
                    } else {
                        handWinner = 'teamBlue'; // UPDATED
                    }
                }

                if (handWinner === 'teamRed') { // UPDATED
                    matchScores.teamRed++; // UPDATED
                    message += "Team Red wins the round!"; // UPDATED
                } else {
                    matchScores.teamBlue++; // UPDATED
                    message += "Team Blue wins the round!"; // UPDATED
                }

                console.log(message);
                updateStatusMessage(message);
                updateScoreDisplay();

                const winnerName = handWinner === 'teamRed' ? 'RED' : 'BLUE';
                const winnerColor = handWinner === 'teamRed' ? 'var(--team-red)' : 'var(--team-blue)';
                specialEventMessage.style.color = winnerColor;

                // Show "TAKES THE GAME!" animation (winning 7 tricks = winning the game)
                console.log(`Showing TAKES THE GAME animation for ${winnerName}`);
                showSpecialEventMessage(`${winnerName}\nTAKES THE GAME!`, 1800);

                // Check for match over (first to 7 games wins the match)
                if (matchScores.teamRed === 7 || matchScores.teamBlue === 7) {
                    const matchWinner = matchScores.teamRed === 7 ? 'teamRed' : 'teamBlue';
                    const loserScore = matchWinner === 'teamRed' ? matchScores.teamBlue : matchScores.teamRed;

                    // Show "TAKES THE MATCH!" animation after game animation
                    setTimeout(() => {
                        showSpecialEventMessage(`${winnerName}\nTAKES THE MATCH!`, 2000);
                    }, 2000);

                    // Reset color after animations
                    setTimeout(() => {
                        specialEventMessage.style.color = 'var(--highlight-player)';
                    }, 4000);

                    // Check for COAT (7-0 victory)
                    if (loserScore === 0) {
                        const winnerNameFull = matchWinner === 'teamRed' ? 'Team Red' : 'Team Blue';
                        setTimeout(() => {
                            showSpecialEventMessage(`COAT!\n${winnerNameFull} wins 7-0!`);
                        }, 4200);
                        setTimeout(() => {
                            showGameOver(matchWinner, "COAT! (7-0)");
                        }, 7200);
                    } else {
                        setTimeout(() => {
                            showGameOver(matchWinner, "Reached 7 games!");
                        }, 4200);
                    }
                } else {
                    // Reset color after animation
                    setTimeout(() => {
                        specialEventMessage.style.color = 'var(--highlight-player)';
                    }, 1800);

                    // Start next hand - winning team picks trump
                    setTimeout(() => startNewHand(handWinner), 2000); // Pause before next hand
                }
            }

            /**
             * Displays the game over modal.
             */
            function showGameOver(winningTeam, message) {
                console.log(`Game Over. Winner: ${winningTeam}. Message: ${message}`);
                gameState = 'GAME_OVER';

                const winnerName = (winningTeam === 'teamRed') ? "Team Red" : "Team Blue";
                const winnerColor = (winningTeam === 'teamRed') ? "var(--team-red)" : "var(--team-blue)";

                // Show win animation
                specialEventMessage.style.color = winnerColor;
                showSpecialEventMessage(`${winnerName.toUpperCase()}\nWINS!`);

                // Show Play Again button after animation (no modal popup)
                setTimeout(() => {
                    // Update button text and state for multiplayer
                    if (isMultiplayer) {
                        if (isHost) {
                            playAgainBtn.textContent = "Play Again";
                            playAgainBtn.disabled = false;
                        } else {
                            playAgainBtn.textContent = "Waiting for host...";
                            playAgainBtn.disabled = true;
                        }
                    } else {
                        playAgainBtn.textContent = "Play Again";
                        playAgainBtn.disabled = false;
                    }

                    // Show just the play again button overlay (no full modal)
                    trumpModal.style.display = 'none';
                    gameOverModal.style.display = 'block';
                    modalOverlay.classList.remove('trump-select');
                    showModal();

                    // Reset color for next time
                    specialEventMessage.style.color = 'var(--highlight-player)';
                }, 2600);
            }

            // --- HELPER & UTILITY FUNCTIONS ---

            /**
             * Gets playable cards from a hand.
             * @param {array} hand - The player's hand.
             * @param {string} ledSuit - The suit that was led.
             * @returns {array} - An array of playable card objects, sorted low to high.
             */
            function getPlayableCards(hand, ledSuit) {
                let playable = [];
                if (!ledSuit) {
                    // Leading, all cards are playable
                    playable = [...hand];
                } else {
                    // Must follow suit
                    const cardsOfLedSuit = hand.filter(c => c.suit === ledSuit);
                    if (cardsOfLedSuit.length > 0) {
                        playable = cardsOfLedSuit;
                    } else {
                        // Can't follow suit, all cards are playable
                        playable = [...hand];
                    }
                }
                // Sort low to high
                playable.sort((a, b) => a.value - b.value);
                return playable;
            }

            /**
             * Finds the winning card entry from a completed trick.
             */
            function findWinningTrickEntry(trick, trump) {
                if (!trick || trick.length === 0) {
                    return null; // Handle empty trick
                }

                let winningEntry = trick[0];
                const ledSuit = winningEntry.card.suit;

                for (let i = 1; i < trick.length; i++) {
                    const currentEntry = trick[i];
                    const winningCard = winningEntry.card;
                    const currentCard = currentEntry.card;

                    if (currentCard.suit === winningCard.suit) {
                        // Same suit, higher rank wins
                        if (currentCard.value > winningCard.value) {
                            winningEntry = currentEntry;
                        }
                    } else if (currentCard.suit === trump) {
                        // Current card is trump
                        if (winningCard.suit !== trump) {
                            // ...and winning card is not, so current wins
                            winningEntry = currentEntry;
                        } else {
                            // ...and winning card is also trump, higher rank wins
                            if (currentCard.value > winningCard.value) {
                                winningEntry = currentEntry;
                            }
                        }
                    }
                    // Otherwise (current is not trump and not led suit), it can't win
                }
                return winningEntry;
            }

            function getNextPlayer(player) {
                const currentIndex = POSITIONS.indexOf(player);
                return POSITIONS[(currentIndex + 1) % 4];
            }

            function getSuitSymbol(suit) {
                if (!suit) return '';
                return { S: '‚ô†', H: '‚ô•', D: '‚ô¶', C: '‚ô£' }[suit];
            }

            function getRankSymbol(rank) {
                return rank; // '10' is already correct
            }

            function capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            // --- UI / RENDERING FUNCTIONS ---

            /**
             * Renders all player hands (human's cards, AI's card backs).
             */
            function renderAllHands() {
                POSITIONS.forEach(pos => {
                    const hand = players[pos].hand;
                    const handEl = playerHands[pos];
                    const countEl = cardCounts[pos];

                    handEl.innerHTML = '';
                    countEl.textContent = hand.length;

                    if (pos === 'south') {
                        // Render human player's hand
                        const totalCards = hand.length;

                        // --- FIX: Use wider spacing for small hands so they don't overlap ---
                        // 65px for small hands (side-by-side), 35px for full hands (overlapped)
                        const cardSlotWidth = totalCards <= 5 ? 65 : 35;
                        const spreadWidth = Math.min((totalCards - 1) * cardSlotWidth, gameContainer.clientWidth * 0.8);
                        // --- End Fix ---

                        const startOffset = -spreadWidth / 2;

                        hand.forEach((card, i) => {
                            const cardEl = createCardElement(card);
                            const offset = startOffset + (i / (totalCards - 1 || 1)) * spreadWidth;
                            cardEl.style.transform = `translateX(${offset}px) rotate(${((i / (totalCards - 1)) - 0.5) * 10}deg)`;
                            cardEl.style.zIndex = i;
                            cardEl.dataset.cardId = card.id;
                            handEl.appendChild(cardEl);
                        });
                    } else {
                        // Render AI players' card backs
                        hand.forEach((card, i) => {
                            const cardBackEl = document.createElement('div');
                            cardBackEl.className = 'card-back';
                            cardBackEl.style.setProperty('--i', i);
                            handEl.appendChild(cardBackEl);
                        });
                    }
                });
            }

            /**
             * Creates the DOM element for a single card face.
             */
            function createCardElement(card) {
                const el = document.createElement('div');
                el.className = `card suit-${card.suit}`;
                const rank = getRankSymbol(card.rank);
                const suit = getSuitSymbol(card.suit);
                el.innerHTML = `
                    <div class="card-rank">${rank}</div>
                    <div class="card-suit">${suit}</div>
                    <div class="card-rank card-rank-bottom">${rank}</div>
                `;
                return el;
            }

            /**
             * Renders a card played into the center trick area.
             */
             function renderPlayedCard(player, card) {
                const cardEl = createCardElement(card);
                const visualPos = getVisualPosition(player);
                const slotEl = trickCards[visualPos];
                slotEl.innerHTML = '';
                slotEl.appendChild(cardEl);
             }

            /**
             * NEW: Adds a card-back to the winner's stack.
             */
            /* REMOVED addCardToWonStack function */

            /**
             * NEW: Highlights playable cards in the human player's hand.
             */
            function highlightPlayableCards() {
                if (currentPlayer !== myPosition) return;

                const hand = players[myPosition].hand;
                const ledSuit = currentHand.length > 0 ? currentHand[0].card.suit : null;

                // Get the actual playable card objects
                const playableCards = getPlayableCards(hand, ledSuit);
                const playableCardIds = new Set(playableCards.map(c => c.id));

                const handCardElements = playerHands.south.querySelectorAll('.card');

                handCardElements.forEach(cardEl => {
                    const cardId = cardEl.dataset.cardId;
                    if (playableCardIds.has(cardId)) {
                        cardEl.classList.add('playable');
                        cardEl.classList.remove('disabled');
                    } else {
                        cardEl.classList.add('disabled');
                        cardEl.classList.remove('playable');
                    }
                });
            }

            /**
             * Clears the center trick area.
             */
            function clearTrickArea() {
                for (const pos in trickCards) {
                    trickCards[pos].innerHTML = '';
                }
            }

            /**
             * NEW: Clears the visual won trick stacks.
             */
            /* REMOVED clearWonTricksDisplay function */

            function updateStatusMessage(msg) {
                statusBar.message.textContent = msg;
            }

            function updateScoreDisplay() {
                // UPDATED: Set color-coded scores
                statusBar.gameScoreRed.textContent = matchScores.teamRed;
                statusBar.gameScoreBlue.textContent = matchScores.teamBlue;
            }

            /**
             * NEW: Updates the hand score display
             */
            function updateHandScoreDisplay() {
                if (statusBar.handScoreRed) { // Add check just in case
                    // UPDATED: Set color-coded scores
                    statusBar.handScoreRed.textContent = handTrickCounts.teamRed;
                    statusBar.handScoreBlue.textContent = handTrickCounts.teamBlue;
                }
            }

            function updateTrumpDisplay() {
                const trumpDisplay = document.getElementById('trump-display');
                if (trumpSuit) {
                    const suit = getSuitSymbol(trumpSuit);
                    trumpDisplay.innerHTML = `Trump: <span class="suit-${trumpSuit}">${suit}</span>`;
                } else {
                    trumpDisplay.innerHTML = '';
                }
            }

            function highlightActivePlayer(player) {
                // Highlight the visual position that corresponds to the logical player
                const visualPos = getVisualPosition(player);
                POSITIONS.forEach(pos => {
                   playerAreas[pos].classList.toggle('active-player', pos === visualPos);
                });
            }

            function showModal() {
                modalOverlay.classList.add('visible');
            }

            function hideModal() {
                modalOverlay.classList.remove('visible');
                modalOverlay.classList.remove('trump-select'); // NEW: Clean up just in case
            }

            /**
             * NEW: Shows a temporary full-screen message for special events.
             */
            function showSpecialEventMessage(message, duration = 2500) {
                console.log(`showSpecialEventMessage called with: "${message}", duration: ${duration}`);
                specialEventMessage.textContent = message;
                specialEventOverlay.classList.add('visible');
                console.log(`Overlay visible class added, should be showing now`);

                // Hide it after a delay
                setTimeout(() => {
                     specialEventOverlay.classList.remove('visible');
                     console.log(`Overlay hidden after ${duration}ms`);
                }, duration);
            }

            // --- MULTIPLAYER FUNCTIONS ---

            /**
             * Shows the main menu modal
             */
            function showMainMenu() {
                // Check URL for join code
                const urlParams = new URLSearchParams(window.location.search);
                const joinCode = urlParams.get('join');

                mainMenuModal.style.display = 'block';
                trumpModal.style.display = 'none';
                gameOverModal.style.display = 'none';
                showModal();

                // Reset menu views
                menuMain.style.display = 'block';
                menuLobby.style.display = 'none';
                menuJoin.style.display = 'none';

                // If URL has join code, go straight to join
                if (joinCode) {
                    showJoinView();
                    joinInput.value = joinCode.toUpperCase();
                }
            }

            /**
             * Generate a random 6-character game code
             */
            function generateGameCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            }

            /**
             * Reset lobby state
             */
            function resetLobby() {
                lobbyPlayers = {
                    south: null,
                    north: null,
                    east: null,
                    west: null
                };
            }

            /**
             * Show the lobby (for both host and guest)
             */
            function showLobby() {
                menuMain.style.display = 'none';
                menuJoin.style.display = 'none';
                menuLobby.style.display = 'block';

                // Hide host info for guests
                document.getElementById('host-info').style.display = isHost ? 'block' : 'none';

                renderLobby();
            }

            /**
             * Render the lobby display
             */
            function renderLobby() {
                // Team Red slots (south, north)
                const redSlot1 = document.getElementById('lobby-red-slot1');
                const redSlot2 = document.getElementById('lobby-red-slot2');

                // Team Blue slots (east, west)
                const blueSlot1 = document.getElementById('lobby-blue-slot1');
                const blueSlot2 = document.getElementById('lobby-blue-slot2');

                // Render each slot
                renderLobbySlot(redSlot1, lobbyPlayers.south, 'south');
                renderLobbySlot(redSlot2, lobbyPlayers.north, 'north');
                renderLobbySlot(blueSlot1, lobbyPlayers.east, 'east');
                renderLobbySlot(blueSlot2, lobbyPlayers.west, 'west');

                // Update player count
                const playerCount = Object.values(lobbyPlayers).filter(p => p !== null).length;
                lobbyStatus.textContent = `${playerCount}/4 players`;
                lobbyStatus.className = playerCount > 0 ? 'status-connected' : 'status-waiting';

                // Enable/disable start button (host only, need at least 1 player)
                if (startGameBtn) {
                    startGameBtn.disabled = !isHost || playerCount === 0;
                }
            }

            /**
             * Render a single lobby slot
             */
            function renderLobbySlot(slotEl, player, position) {
                if (player) {
                    const isMe = player.peerId === (peer ? peer.id : 'host');
                    const nameSpan = `<span>${player.name}${isMe ? ' (You)' : ''}</span>`;

                    // Show switch button if it's me and I'm not the only player
                    let switchBtn = '';
                    if (isMe) {
                        const canSwitchTo = getAvailableTeamSwitch(position);
                        if (canSwitchTo) {
                            switchBtn = `<button class="team-select-btn" onclick="switchTeam('${position}', '${canSwitchTo}')">Switch</button>`;
                        }
                    }

                    slotEl.innerHTML = nameSpan + switchBtn;
                    slotEl.className = `lobby-player lobby-player-filled${isMe ? ' lobby-player-you' : ''}`;
                } else {
                    slotEl.innerHTML = '<span>Empty (AI)</span>';
                    slotEl.className = 'lobby-player lobby-player-empty';
                }
            }

            /**
             * Get available position to switch to
             */
            function getAvailableTeamSwitch(currentPos) {
                const teamRed = ['south', 'north'];
                const teamBlue = ['east', 'west'];

                if (teamRed.includes(currentPos)) {
                    // Can switch to blue if there's an empty slot
                    for (const pos of teamBlue) {
                        if (!lobbyPlayers[pos]) return pos;
                    }
                } else {
                    // Can switch to red if there's an empty slot
                    for (const pos of teamRed) {
                        if (!lobbyPlayers[pos]) return pos;
                    }
                }
                return null;
            }

            /**
             * Switch team (called from lobby UI)
             */
            window.switchTeam = function(fromPos, toPos) {
                const player = lobbyPlayers[fromPos];
                if (!player) return;

                lobbyPlayers[fromPos] = null;
                lobbyPlayers[toPos] = player;
                myPosition = toPos;

                renderLobby();

                // Broadcast update if host
                if (isHost) {
                    broadcastLobbyState();
                } else {
                    // Guest sends switch request to host
                    broadcast({ type: 'switchTeam', fromPos, toPos, peerId: peer.id });
                }
            };

            /**
             * Broadcast lobby state to all connected peers
             */
            function broadcastLobbyState() {
                broadcast({ 
                    type: 'lobbyState', 
                    lobby: lobbyPlayers
                });
            }

            /**
             * Host a game - show lobby
             */
            function showHostView() {
                myName = nameInput.value.trim() || 'Player';
                gameCode = generateGameCode();
                gameCodeDisplay.textContent = gameCode;

                const shareUrl = `${window.location.origin}${window.location.pathname}?join=${gameCode}`;
                shareLinkDisplay.textContent = shareUrl;

                // Initialize PeerJS as host
                isHost = true;
                isMultiplayer = true;
                myPosition = 'south';

                // Reset and add host to lobby
                resetLobby();
                lobbyPlayers.south = { name: myName, peerId: 'host', position: 'south' };

                peer = new Peer('trump-' + gameCode);

                peer.on('open', (id) => {
                    console.log('Host peer opened with ID:', id);
                    // Show share button
                    document.getElementById('share-btn').style.display = 'flex';
                    showLobby();
                });

                peer.on('connection', (conn) => {
                    console.log('New player connecting...');
                    
                    // Check if game is already in progress
                    if (gameState !== 'INIT' && gameState !== 'TRUMP_SELECTION' && gameState !== 'DEALING') {
                        console.log('Game already in progress, rejecting connection');
                        conn.on('open', () => {
                            conn.send({ type: 'error', message: 'Game already in progress. Cannot join.' });
                            conn.close();
                        });
                        return;
                    }
                    
                    connections.push(conn);

                    conn.on('open', () => {
                        // Wait for player info
                    });

                    conn.on('data', (data) => {
                        handlePeerData(data, conn);
                    });

                    conn.on('close', () => {
                        console.log('Player disconnected');
                        // Remove from lobby
                        for (const pos of POSITIONS) {
                            if (lobbyPlayers[pos] && lobbyPlayers[pos].peerId === conn.peer) {
                                lobbyPlayers[pos] = null;
                                break;
                            }
                        }
                        renderLobby();
                        broadcastLobbyState();
                    });
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    lobbyStatus.textContent = 'Connection error: ' + err.type;
                    lobbyStatus.className = 'status-error';
                });
            }

            /**
             * Show the join game view
             */
            function showJoinView() {
                menuMain.style.display = 'none';
                menuJoin.style.display = 'block';
                joinInput.value = '';
                joinStatus.textContent = '';
            }

            /**
             * Connect to a host's game
             */
            function connectToHost() {
                const code = joinInput.value.trim().toUpperCase();
                if (code.length !== 6) {
                    joinStatus.textContent = 'Please enter a 6-character code';
                    joinStatus.className = 'status-error';
                    return;
                }

                myName = joinNameInput.value.trim() || 'Player';
                joinStatus.textContent = 'Connecting...';
                joinStatus.className = 'status-waiting';

                isHost = false;
                isMultiplayer = true;
                myPosition = 'north'; // Guest plays as North

                peer = new Peer();

                peer.on('open', () => {
                    console.log('Guest peer opened, connecting to host...');

                    const conn = peer.connect('trump-' + code);
                    connections.push(conn);

                    conn.on('open', () => {
                        console.log('Connected to host!');
                        joinStatus.textContent = 'Connected! Joining lobby...';
                        joinStatus.className = 'status-connected';

                        // Send player info to host
                        conn.send({ type: 'joinLobby', name: myName, peerId: peer.id });
                    });

                    conn.on('data', (data) => {
                        handlePeerData(data);
                    });

                    conn.on('close', () => {
                        console.log('Host disconnected');
                        updateStatusMessage('Host disconnected!');
                    });
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    joinStatus.textContent = 'Connection failed: ' + err.type;
                    joinStatus.className = 'status-error';
                });
            }

            /**
             * Send data to all connected peers
             */
            function broadcast(data) {
                connections.forEach(conn => {
                    if (conn.open) {
                        conn.send(data);
                    }
                });
            }

            /**
             * Handle incoming peer data
             */
            function handlePeerData(data, conn) {
                console.log('Received:', data.type);

                switch (data.type) {
                    case 'joinLobby':
                        // Guest joining lobby (host receives this) - ONLY BEFORE GAME STARTS
                        if (isHost && gameState === 'INIT') {
                            if (data.position) {
                                // Guest selected a position
                                if (!lobbyPlayers[data.position]) {
                                    lobbyPlayers[data.position] = {
                                        name: data.name,
                                        peerId: data.peerId,
                                        position: data.position
                                    };

                                    renderLobby();
                                    broadcastLobbyState();
                                }
                            } else {
                                // Guest requesting available slots
                                const availableSlots = {
                                    teamRed: [],
                                    teamBlue: []
                                };
                                
                                if (!lobbyPlayers.north) availableSlots.teamRed.push('north');
                                if (!lobbyPlayers.south && data.peerId !== 'host') availableSlots.teamRed.push('south');
                                if (!lobbyPlayers.east) availableSlots.teamBlue.push('east');
                                if (!lobbyPlayers.west) availableSlots.teamBlue.push('west');

                                // Send available slots back to guest
                                const conn = connections.find(c => c.peer === data.peerId);
                                if (conn) {
                                    conn.send({ 
                                        type: 'availableSlots', 
                                        slots: availableSlots,
                                        lobby: lobbyPlayers,
                                        inGame: false
                                    });
                                }
                            }
                        } else if (isHost && gameState !== 'INIT') {
                            // Game already started, reject join
                            const conn = connections.find(c => c.peer === data.peerId);
                            if (conn) {
                                conn.send({ type: 'gameInProgress' });
                                conn.close();
                            }
                        }
                        break;

                    case 'lobbyState':
                        // Guest receives lobby state from host
                        if (!isHost) {
                            lobbyPlayers = data.lobby;
                            // Find my position
                            for (const pos of POSITIONS) {
                                if (lobbyPlayers[pos] && lobbyPlayers[pos].peerId === peer.id) {
                                    myPosition = pos;
                                    break;
                                }
                            }
                            
                            // Show lobby if we have a position
                            if (myPosition) {
                                showLobby();
                                renderLobby();
                            }
                        }
                        break;

                    case 'switchTeam':
                        // Guest wants to switch teams (host receives this)
                        if (isHost) {
                            const player = lobbyPlayers[data.fromPos];
                            if (player && player.peerId === data.peerId && !lobbyPlayers[data.toPos]) {
                                lobbyPlayers[data.fromPos] = null;
                                lobbyPlayers[data.toPos] = player;
                                player.position = data.toPos; // Update player's position
                                renderLobby();
                                broadcastLobbyState();
                            }
                        }
                        break;

                    case 'startGame':
                        // Host started the game
                        if (!isHost) {
                            playerNames = data.playerNames;
                            updatePlayerAreaNames();
                            hideModal();
                            // Show hamburger menu for guests
                            document.getElementById('menu-btn').style.display = 'flex';
                        }
                        break;

                    case 'gameState':
                        // Full game state sync from host
                        receiveGameState(data.state);
                        break;

                    case 'cardPlayed':
                        // A card was played (from guest to host, or host broadcasting)
                        if (isHost) {
                            // Host receives guest's play, remove card from player's hand first
                            const playerHand = players[data.player].hand;
                            const cardIndex = playerHand.findIndex(c => c.id === data.card.id);
                            if (cardIndex !== -1) {
                                playerHand.splice(cardIndex, 1);
                            }
                            // Then process the play
                            playCard(data.player, data.card);
                        } else {
                            // Guest receives broadcast of plays
                            playCardFromNetwork(data.player, data.card);
                        }
                        break;

                    case 'trumpSelected':
                        if (!isHost) {
                            setTrumpFromNetwork(data.suit);
                        }
                        break;

                    case 'redeal':
                        // Host triggered a redeal due to no trumps
                        if (!isHost) {
                            updateStatusMessage("Redealing due to no trumps...");
                        }
                        break;

                    case 'replayGame':
                        // Host started a new game
                        if (!isHost) {
                            hideModal();
                            updateStatusMessage("Starting new game...");
                        }
                        break;

                    case 'availableSlots':
                        // Guest receives available slots from host
                        if (!isHost) {
                            showTeamSelection(data.slots, data.lobby, data.inGame);
                        }
                        break;

                    case 'gameInProgress':
                        // Game already started, can't join
                        if (!isHost) {
                            joinStatus.textContent = 'Game already in progress. Cannot join.';
                            joinStatus.className = 'status-error';
                            if (peer) {
                                peer.destroy();
                                peer = null;
                            }
                        }
                        break;

                    case 'error':
                        // Generic error message from host
                        if (!isHost) {
                            joinStatus.textContent = data.message || 'An error occurred';
                            joinStatus.className = 'status-error';
                            if (peer) {
                                peer.destroy();
                                peer = null;
                            }
                        }
                        break;

                    case 'reaction':
                        // Player sent a reaction
                        showReaction(data.position, data.emoji);
                        // If host, broadcast to all other guests (except sender)
                        if (isHost) {
                            // Find the sender's connection
                            const senderConn = conn;
                            // Broadcast to everyone except the sender
                            connections.forEach(c => {
                                if (c.open && c !== senderConn) {
                                    c.send({ type: 'reaction', position: data.position, emoji: data.emoji });
                                }
                            });
                        }
                        break;
                }
            }

            /**
             * Receive full game state (for guest)
             */
            function receiveGameState(state) {
                deck = state.deck;
                matchScores = state.matchScores;
                currentHand = state.currentHand;
                trumpSuit = state.trumpSuit;
                trumpCaller = state.trumpCaller;
                handLeader = state.handLeader;
                currentPlayer = state.currentPlayer;
                handTrickCounts = state.handTrickCounts;
                gameState = state.gameState;

                // Update myPosition if provided
                if (state.myPosition) {
                    myPosition = state.myPosition;
                }

                // Set up players - guest only sees their own cards
                players = {
                    south: { hand: [], isAI: true, team: 'teamRed' },
                    east: { hand: [], isAI: true, team: 'teamBlue' },
                    north: { hand: [], isAI: true, team: 'teamRed' },
                    west: { hand: [], isAI: true, team: 'teamBlue' },
                };
                // Set guest's hand at their position
                if (myPosition && state.myHand) {
                    players[myPosition].hand = state.myHand;
                    players[myPosition].isAI = false;
                    // Sort hand if trump is set
                    if (trumpSuit) {
                        sortHand(players[myPosition].hand);
                    }
                }

                // Update card counts from state (mapped to visual positions)
                if (state.cardCounts) {
                    // Get which logical player appears in each visual position
                    const southPlayer = getLogicalPosition('south');
                    const northPlayer = getLogicalPosition('north');
                    const eastPlayer = getLogicalPosition('east');
                    const westPlayer = getLogicalPosition('west');

                    cardCounts.south.textContent = state.cardCounts[southPlayer];
                    cardCounts.north.textContent = state.cardCounts[northPlayer];
                    cardCounts.east.textContent = state.cardCounts[eastPlayer];
                    cardCounts.west.textContent = state.cardCounts[westPlayer];
                }

                updateScoreDisplay();
                updateHandScoreDisplay();
                updateTrumpDisplay();
                renderGuestHands();
                renderCurrentTrick();

                // Show hamburger menu when receiving game state (mid-game join)
                document.getElementById('menu-btn').style.display = 'flex';
                hideModal();

                if (gameState === 'TRUMP_SELECTION' && currentPlayer === myPosition) {
                    promptForTrump();
                } else if (gameState === 'PLAYING' && currentPlayer === myPosition) {
                    highlightPlayableCards();
                    highlightActivePlayer(myPosition);
                    updateStatusMessage("Your turn. Select a card to play.");
                } else {
                    highlightActivePlayer(currentPlayer);
                }
            }

            /**
             * Send game state to guests
             */
            function sendGameState() {
                if (!isMultiplayer || !isHost) return;

                // Send personalized state to each guest based on their position
                connections.forEach(conn => {
                    if (!conn.open) return;

                    // Find this connection's position
                    let guestPosition = null;
                    for (const pos of POSITIONS) {
                        if (lobbyPlayers[pos] && lobbyPlayers[pos].peerId === conn.peer) {
                            guestPosition = pos;
                            break;
                        }
                    }

                    if (!guestPosition) return;

                    const state = {
                        deck: deck,
                        matchScores: matchScores,
                        currentHand: currentHand,
                        trumpSuit: trumpSuit,
                        trumpCaller: trumpCaller,
                        handLeader: handLeader,
                        currentPlayer: currentPlayer,
                        handTrickCounts: handTrickCounts,
                        gameState: gameState,
                        myHand: players[guestPosition].hand, // Send this guest's cards
                        myPosition: guestPosition, // Tell guest their position
                        cardCounts: {
                            south: players.south.hand.length,
                            north: players.north.hand.length,
                            east: players.east.hand.length,
                            west: players.west.hand.length,
                        }
                    };

                    conn.send({ type: 'gameState', state: state });
                });
            }

            /**
             * Render hands for guest (only sees their own cards)
             */
            function renderGuestHands() {
                // Clear all hands first
                POSITIONS.forEach(pos => {
                    playerHands[pos].innerHTML = '';
                });

                if (!myPosition) return;

                // Render guest's hand in the south position visually (bottom of screen)
                const hand = players[myPosition].hand;
                const handEl = playerHands.south; // Guest sees their cards at bottom
                const totalCards = hand.length;

                const cardSlotWidth = totalCards <= 5 ? 65 : 35;
                const spreadWidth = Math.min((totalCards - 1) * cardSlotWidth, gameContainer.clientWidth * 0.8);
                const startOffset = -spreadWidth / 2;

                hand.forEach((card, i) => {
                    const cardEl = createCardElement(card);
                    const offset = startOffset + (i / (totalCards - 1 || 1)) * spreadWidth;
                    cardEl.style.transform = `translateX(${offset}px) rotate(${((i / (totalCards - 1)) - 0.5) * 10}deg)`;
                    cardEl.style.zIndex = i;
                    cardEl.dataset.cardId = card.id;
                    handEl.appendChild(cardEl);
                });

                // Update card count display for guest's position
                cardCounts.south.textContent = players[myPosition].hand.length;
            }

            /**
             * Render the current trick cards
             */
            function renderCurrentTrick() {
                clearTrickArea();
                currentHand.forEach(entry => {
                    renderPlayedCard(entry.player, entry.card);
                });
            }

            /**
             * Play a card received from network (for guest)
             */
            function playCardFromNetwork(player, card) {
                currentHand.push({ player, card });
                renderPlayedCard(player, card);

                // If it's guest's card being played back, update their hand
                if (player === myPosition && myPosition) {
                    const cardIndex = players[myPosition].hand.findIndex(c => c.id === card.id);
                    if (cardIndex !== -1) {
                        players[myPosition].hand.splice(cardIndex, 1);
                        renderGuestHands();
                    }
                }
            }

            /**
             * Set trump from network (for guest)
             */
            function setTrumpFromNetwork(suit) {
                trumpSuit = suit;
                updateTrumpDisplay();
                if (myPosition) {
                    sortHand(players[myPosition].hand);
                }
                renderGuestHands();
            }

            /**
             * Copy share link to clipboard
             */
            function copyShareLink() {
                const shareUrl = `${window.location.origin}${window.location.pathname}?join=${gameCode}`;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    const btn = document.getElementById('copy-link-btn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => {
                        btn.textContent = 'Copy';
                    }, 2000);
                });
            }

            /**
             * Start game from lobby (host only)
             */
            function startGameFromLobby() {
                if (!isHost) return;

                // Set up player names from lobby
                for (const pos of POSITIONS) {
                    if (lobbyPlayers[pos]) {
                        playerNames[pos] = lobbyPlayers[pos].name;
                    } else {
                        playerNames[pos] = capitalize(pos) + ' (AI)';
                    }
                }

                // Broadcast game start with player names
                broadcast({ type: 'startGame', playerNames: playerNames });

                // Update player area displays
                updatePlayerAreaNames();

                // Hide all modals explicitly
                mainMenuModal.style.display = 'none';
                menuLobby.style.display = 'none';
                hideModal();

                // Show hamburger menu button
                document.getElementById('menu-btn').style.display = 'flex';

                // Start match
                initMatch();
            }

            /**
             * Update player area displays with names (rotated based on myPosition)
             */
            function updatePlayerAreaNames() {
                // Get which logical player appears in each visual position
                const southPlayer = getLogicalPosition('south');
                const northPlayer = getLogicalPosition('north');
                const eastPlayer = getLogicalPosition('east');
                const westPlayer = getLogicalPosition('west');

                // Update player names while preserving reaction buttons
                const updatePlayerName = (pos, name) => {
                    const nameEl = document.querySelector(`#player-${pos}-area .player-name`);
                    const btn = nameEl.querySelector('.reaction-btn');
                    nameEl.textContent = name;
                    if (btn) {
                        nameEl.appendChild(btn); // Re-add the button
                    }
                };
                
                updatePlayerName('south', playerNames[southPlayer]);
                updatePlayerName('north', playerNames[northPlayer]);
                updatePlayerName('east', playerNames[eastPlayer]);
                updatePlayerName('west', playerNames[westPlayer]);

                // Update team colors in player info
                const getTeamInfo = (pos) => {
                    const team = (pos === 'south' || pos === 'north') ? 'teamRed' : 'teamBlue';
                    const teamClass = team === 'teamRed' ? 'team-red-text' : 'team-blue-text';
                    const teamName = team === 'teamRed' ? 'Team Red' : 'Team Blue';
                    return `<span class="${teamClass}">${teamName}</span>`;
                };

                document.querySelector('#player-south-area .player-info').innerHTML =
                    `${getTeamInfo(southPlayer)} | <span id="card-count-south">0</span> cards`;
                document.querySelector('#player-north-area .player-info').innerHTML =
                    `${getTeamInfo(northPlayer)} | <span id="card-count-north">0</span> cards`;
                document.querySelector('#player-east-area .player-info').innerHTML =
                    `${getTeamInfo(eastPlayer)} | <span id="card-count-east">0</span> cards`;
                document.querySelector('#player-west-area .player-info').innerHTML =
                    `${getTeamInfo(westPlayer)} | <span id="card-count-west">0</span> cards`;

                // Re-cache card count elements since we rebuilt the HTML
                cardCounts.south = document.getElementById('card-count-south');
                cardCounts.north = document.getElementById('card-count-north');
                cardCounts.east = document.getElementById('card-count-east');
                cardCounts.west = document.getElementById('card-count-west');
            }

            /**
             * Reset to main menu
             */
            function backToMenu() {
                // Clean up peer connections
                if (peer) {
                    peer.destroy();
                    peer = null;
                }
                connections = [];
                isHost = false;
                isMultiplayer = false;
                myPosition = 'south';
                gameCode = '';
                gameState = 'INIT';
                resetLobby();

                // Hide share and menu buttons
                document.getElementById('share-btn').style.display = 'none';
                document.getElementById('menu-btn').style.display = 'none';

                // Reset player names
                playerNames = {
                    south: 'South',
                    north: 'North',
                    east: 'East',
                    west: 'West'
                };

                showMainMenu();
            }

            // --- EVENT LISTENERS ---

            // Trump selection buttons
            trumpButtons.addEventListener('click', (e) => {
                const btn = e.target.closest('.trump-btn');
                if (btn && gameState === 'TRUMP_SELECTION') {
                    const suit = btn.dataset.suit;
                    setTrump(suit);
                }
            });

            // Play card click
            playerHands.south.addEventListener('click', (e) => {
                const cardEl = e.target.closest('.card');

                // Determine which position the local player controls
                const myPos = myPosition;

                // Check if it's our turn
                if (gameState !== 'PLAYING' || currentPlayer !== myPos || !cardEl) {
                    return;
                }

                if (cardEl.classList.contains('disabled')) {
                    updateStatusMessage("You must follow suit if you can!");
                    return;
                }

                if (cardEl.classList.contains('playable')) {
                    const cardId = cardEl.dataset.cardId;
                    const hand = players[myPos].hand;
                    const cardIndex = hand.findIndex(c => c.id === cardId);
                    const card = hand.splice(cardIndex, 1)[0];

                    // Remove all highlights
                    playerHands.south.querySelectorAll('.card').forEach(el => {
                       el.classList.remove('playable', 'disabled');
                    });

                    // If guest, send to host; if host or single player, play directly
                    if (isMultiplayer && !isHost) {
                        // Guest sends card play to host
                        broadcast({ type: 'cardPlayed', player: myPos, card: card });
                        // Re-render guest's hand locally
                        renderGuestHands();
                    } else {
                        playCard(myPos, card);
                    }
                }
            });

            // Play again
            playAgainBtn.addEventListener('click', () => {
                if (isMultiplayer && isHost) {
                    // Host broadcasts replay to all guests
                    broadcast({ type: 'replayGame' });
                    initMatch();
                } else if (isMultiplayer && !isHost) {
                    // Guest can't start replay, show message
                    updateStatusMessage("Waiting for host to start new match...");
                } else {
                    // Single player
                    initMatch();
                }
            });

            // --- MENU EVENT LISTENERS ---

            // Play vs AI button
            document.getElementById('play-ai-btn').addEventListener('click', () => {
                myName = nameInput.value.trim() || 'Player';
                playerNames.south = myName;
                isMultiplayer = false;
                isHost = false;
                myPosition = 'south';
                updatePlayerAreaNames();
                hideModal();
                // Show hamburger menu for single player too
                document.getElementById('menu-btn').style.display = 'flex';
                initMatch();
            });

            // Host game button
            document.getElementById('host-game-btn').addEventListener('click', showHostView);

            // Join game button
            document.getElementById('join-game-btn').addEventListener('click', showJoinView);

            // Connect to host button
            document.getElementById('join-connect-btn').addEventListener('click', connectToHost);

            // Copy code button
            document.getElementById('copy-code-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(gameCode).then(() => {
                    const btn = document.getElementById('copy-code-btn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy', 2000);
                });
            });

            // Copy link button
            document.getElementById('copy-link-btn').addEventListener('click', copyShareLink);

            // Start game button (lobby)
            document.getElementById('start-game-btn').addEventListener('click', startGameFromLobby);

            // Back buttons
            document.getElementById('lobby-back-btn').addEventListener('click', backToMenu);
            document.getElementById('join-back-btn').addEventListener('click', backToMenu);

            // Menu button (hamburger)
            document.getElementById('menu-btn').addEventListener('click', () => {
                showGameMenu();
            });

            // Help button
            document.getElementById('help-btn').addEventListener('click', () => {
                document.getElementById('help-modal').style.display = 'block';
                trumpModal.style.display = 'none';
                gameOverModal.style.display = 'none';
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('game-menu-modal').style.display = 'none';
                showModal();
            });

            document.getElementById('close-help-btn').addEventListener('click', () => {
                hideModal();
            });

            // Share button
            document.getElementById('share-btn').addEventListener('click', () => {
                if (isMultiplayer && isHost) {
                    document.getElementById('share-code-text').textContent = gameCode;
                    const shareUrl = `${window.location.origin}${window.location.pathname}?join=${gameCode}`;
                    document.getElementById('share-url-text').textContent = shareUrl;
                    
                    document.getElementById('share-modal').style.display = 'block';
                    trumpModal.style.display = 'none';
                    gameOverModal.style.display = 'none';
                    document.getElementById('help-modal').style.display = 'none';
                    showModal();
                }
            });

            document.getElementById('close-share-btn').addEventListener('click', () => {
                hideModal();
            });

            document.getElementById('copy-code-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(gameCode).then(() => {
                    const btn = document.getElementById('copy-code-btn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy Code', 2000);
                });
            });

            document.getElementById('copy-url-btn').addEventListener('click', () => {
                const shareUrl = `${window.location.origin}${window.location.pathname}?join=${gameCode}`;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    const btn = document.getElementById('copy-url-btn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy Link', 2000);
                });
            });

            // Game menu buttons
            document.getElementById('close-game-menu-btn').addEventListener('click', () => {
                hideModal();
            });

            document.getElementById('new-game-btn').addEventListener('click', () => {
                // Hide game menu and show main menu
                document.getElementById('game-menu-modal').style.display = 'none';
                backToMenu();
            });

            document.getElementById('kick-player-btn').addEventListener('click', () => {
                showKickPlayerMenu();
            });

            document.getElementById('host-link-btn').addEventListener('click', () => {
                if (isMultiplayer && isHost) {
                    document.getElementById('share-code-text').textContent = gameCode;
                    const shareUrl = `${window.location.origin}${window.location.pathname}?join=${gameCode}`;
                    document.getElementById('share-url-text').textContent = shareUrl;
                    
                    document.getElementById('share-modal').style.display = 'block';
                    document.getElementById('game-menu-modal').style.display = 'none';
                    trumpModal.style.display = 'none';
                    gameOverModal.style.display = 'none';
                    document.getElementById('help-modal').style.display = 'none';
                    showModal();
                }
            });

            document.getElementById('about-btn').addEventListener('click', () => {
                document.getElementById('about-modal').style.display = 'block';
                document.getElementById('game-menu-modal').style.display = 'none';
                trumpModal.style.display = 'none';
                gameOverModal.style.display = 'none';
                document.getElementById('help-modal').style.display = 'none';
                document.getElementById('share-modal').style.display = 'none';
                showModal();
            });

            document.getElementById('close-about-btn').addEventListener('click', () => {
                hideModal();
            });

            document.getElementById('back-to-game-menu-btn').addEventListener('click', () => {
                showGameMenu();
            });

            // Helper functions for game menu
            function showGameMenu() {
                document.getElementById('game-menu-modal').style.display = 'block';
                trumpModal.style.display = 'none';
                gameOverModal.style.display = 'none';
                document.getElementById('help-modal').style.display = 'none';
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('kick-player-modal').style.display = 'none';
                document.getElementById('about-modal').style.display = 'none';

                // Hide kick player and host link buttons (removed features)
                document.getElementById('kick-player-btn').style.display = 'none';
                document.getElementById('host-link-btn').style.display = 'none';

                showModal();
            }

            function showKickPlayerMenu() {
                const kickList = document.getElementById('kick-player-list');
                kickList.innerHTML = '';

                // Show all human players except host
                for (const pos of POSITIONS) {
                    if (lobbyPlayers[pos] && lobbyPlayers[pos].peerId !== 'host') {
                        const item = document.createElement('div');
                        item.className = 'kick-player-item';
                        item.innerHTML = `
                            <span class="kick-player-name">${lobbyPlayers[pos].name} (${capitalize(pos)})</span>
                            <button class="kick-btn" onclick="window.kickPlayerGlobal('${pos}')">Kick</button>
                        `;
                        kickList.appendChild(item);
                    }
                }

                if (kickList.children.length === 0) {
                    kickList.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No players to kick</p>';
                }

                document.getElementById('kick-player-modal').style.display = 'block';
                document.getElementById('game-menu-modal').style.display = 'none';
            }

            function kickPlayer(position) {
                if (!isHost) return;

                const player = lobbyPlayers[position];
                if (!player) return;

                // Find and close the connection
                const conn = connections.find(c => c.peer === player.peerId);
                if (conn) {
                    conn.close();
                }

                // Remove from lobby
                lobbyPlayers[position] = null;

                renderLobby();
                broadcastLobbyState();
                hideModal();
            }

            // Make kickPlayer available globally
            window.kickPlayerGlobal = kickPlayer;

            // Team selection for guests
            let availableTeamSlots = null;

            function showTeamSelection(slots, lobby, inGame) {
                availableTeamSlots = slots;
                
                // Show which slots are available
                const redSlotsEl = document.getElementById('team-select-red-slots');
                const blueSlotsEl = document.getElementById('team-select-blue-slots');
                
                redSlotsEl.innerHTML = '';
                blueSlotsEl.innerHTML = '';

                // Show Team Red slots
                ['south', 'north'].forEach(pos => {
                    const slotEl = document.createElement('div');
                    slotEl.className = 'lobby-player';
                    if (lobby[pos]) {
                        slotEl.classList.add('lobby-player-filled');
                        slotEl.textContent = `${lobby[pos].name} (${capitalize(pos)})`;
                    } else {
                        slotEl.classList.add('lobby-player-empty');
                        slotEl.textContent = `${capitalize(pos)} - Available`;
                    }
                    redSlotsEl.appendChild(slotEl);
                });

                // Show Team Blue slots
                ['east', 'west'].forEach(pos => {
                    const slotEl = document.createElement('div');
                    slotEl.className = 'lobby-player';
                    if (lobby[pos]) {
                        slotEl.classList.add('lobby-player-filled');
                        slotEl.textContent = `${lobby[pos].name} (${capitalize(pos)})`;
                    } else {
                        slotEl.classList.add('lobby-player-empty');
                        slotEl.textContent = `${capitalize(pos)} - Available`;
                    }
                    blueSlotsEl.appendChild(slotEl);
                });

                // Enable/disable buttons based on availability
                document.getElementById('join-team-red-btn').disabled = slots.teamRed.length === 0;
                document.getElementById('join-team-blue-btn').disabled = slots.teamBlue.length === 0;

                // Hide all other modals and show team selection
                mainMenuModal.style.display = 'none';
                trumpModal.style.display = 'none';
                gameOverModal.style.display = 'none';
                document.getElementById('help-modal').style.display = 'none';
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('game-menu-modal').style.display = 'none';
                document.getElementById('kick-player-modal').style.display = 'none';
                document.getElementById('about-modal').style.display = 'none';
                
                document.getElementById('team-selection-modal').style.display = 'block';
                showModal();
            }

            function joinTeam(team) {
                if (!availableTeamSlots) return;

                const slots = team === 'red' ? availableTeamSlots.teamRed : availableTeamSlots.teamBlue;
                if (slots.length === 0) return;

                // Pick first available slot in chosen team
                const position = slots[0];
                myPosition = position;

                // Send join request with position
                broadcast({ type: 'joinLobby', name: myName, peerId: peer.id, position: position });

                // Hide team selection
                hideModal();
                updateStatusMessage('Joining game...');
            }

            // Team selection button listeners
            document.getElementById('join-team-red-btn').addEventListener('click', () => {
                joinTeam('red');
            });

            document.getElementById('join-team-blue-btn').addEventListener('click', () => {
                joinTeam('blue');
            });

            // --- REACTION SYSTEM ---
            const reactionPicker = document.getElementById('reaction-picker');
            let reactionPickerVisible = false;

            // Show reaction button for human players
            function updateReactionButtons() {
                const southBtn = document.getElementById('reaction-btn-south');
                if (southBtn) {
                    southBtn.style.display = 'inline-block';
                }
                
                // In multiplayer, show for other human players
                if (isMultiplayer) {
                    ['north', 'east', 'west'].forEach(pos => {
                        const btn = document.getElementById(`reaction-btn-${pos}`);
                        if (btn && lobbyPlayers[pos] && players[pos] && !players[pos].isAI) {
                            btn.style.display = 'inline-block';
                        }
                    });
                }
            }

            // Handle reaction button clicks for all positions
            function setupReactionListeners() {
                ['south', 'north', 'east', 'west'].forEach(pos => {
                    const btn = document.getElementById(`reaction-btn-${pos}`);
                    if (btn) {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log(`Reaction button clicked for ${pos}`);
                            if (reactionPickerVisible) {
                                reactionPicker.style.display = 'none';
                                reactionPickerVisible = false;
                            } else {
                                // Show picker centered (CSS handles positioning)
                                reactionPicker.style.display = 'flex';
                                reactionPicker.dataset.position = pos;
                                reactionPickerVisible = true;
                                console.log('Reaction picker shown');
                            }
                        });
                    }
                });
            }

            // Set up listeners immediately
            setupReactionListeners();

            // Close picker when clicking outside
            document.addEventListener('click', (e) => {
                if (reactionPickerVisible && !reactionPicker.contains(e.target)) {
                    reactionPicker.style.display = 'none';
                    reactionPickerVisible = false;
                }
            });

            // Handle reaction selection
            document.querySelectorAll('.reaction-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const emoji = e.target.dataset.emoji;
                    // The picker stores the visual position, but we need to send the logical position
                    const visualPos = reactionPicker.dataset.position || 'south';
                    const logicalPos = getLogicalPosition(visualPos);
                    console.log(`Sending reaction: ${emoji} from visual ${visualPos} (logical ${logicalPos})`);
                    sendReaction(logicalPos, emoji);
                    reactionPicker.style.display = 'none';
                    reactionPickerVisible = false;
                });
            });

            console.log('Reaction system initialized');

            // Update reaction buttons when game starts
            updateReactionButtons();

            function sendReaction(position, emoji) {
                // Show reaction locally first
                showReaction(position, emoji);
                
                // In multiplayer, send to other players
                if (isMultiplayer) {
                    if (isHost) {
                        // Host broadcasts to all guests
                        broadcast({ type: 'reaction', position: position, emoji: emoji });
                    } else {
                        // Guest sends to host (host will broadcast to others)
                        broadcast({ type: 'reaction', position: position, emoji: emoji });
                    }
                }
            }

            function showReaction(position, emoji) {
                const visualPos = getVisualPosition(position);
                const reactionEl = document.getElementById(`reaction-${visualPos}`);
                reactionEl.textContent = emoji;
                reactionEl.style.display = 'block';
                
                // Hide after 8 seconds
                setTimeout(() => {
                    reactionEl.style.display = 'none';
                }, 8000);
            }

            // --- START ---
            showMainMenu();
        });
    </script>
</body>
</html>
